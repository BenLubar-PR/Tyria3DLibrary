!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;"undefined"!=typeof window?t=window:"undefined"!=typeof global?t=global:"undefined"!=typeof self&&(t=self),t.T3D=e()}}(function(){return function n(i,o,s){function l(a,e){if(!o[a]){if(!i[a]){var t="function"==typeof require&&require;if(!e&&t)return t(a,!0);if(d)return d(a,!0);throw new Error("Cannot find module '"+a+"'")}var r=o[a]={exports:{}};i[a][0].call(r.exports,function(e){var t=i[a][1][e];return l(t||e)},r,r.exports,n,i,o,s)}return o[a].exports}for(var d="function"==typeof require&&require,e=0;e<s.length;e++)l(s[e]);return l}({1:[function(e,t,a){var y=e("../format/file/GW2File.js"),r=e("../format/definition/ANDAT"),i=e("../format/definition/MFT"),f=e("../util/MathUtils.js"),l=e("../MapFileList"),n=function(e,t,a){this.fileListeners=[],this.dat=e,this.version=t,this.logger=a||T3D.Logger};n.prototype.parseHeaderAsync=function(e){this.onFullyLoaded=e,this.loadFilePart(this.dat,0,40,this.readANDatHeader)},n.prototype.connectInflater=function(e,t){var a=this;this.NaClInflater=e,t.addEventListener("message",function(e){a.NaClListener.call(a,e)},!0)},n.prototype.NaClListener=function(a){if("string"!=typeof a.data){var e=a.data[0];this.fileListeners[e]&&(this.fileListeners[e].forEach(function(e){var t=a.data;e(t[1],t[2],t[3],t[4])}),this.fileListeners[e]=null)}else this.logger.log(T3D.Logger.TYPE_WARNING,"NaCl threw an error",a.data)},n.prototype.readANDatHeader=function(e){this.fileHeader=e.readStruct(r),this.logger.log(T3D.Logger.TYPE_DEBUG,"Loaded Main .dat header",this.fileHeader),this.fileHeader.mftOffset=f.arr32To64(this.fileHeader.mftOffset),this.loadFilePart(this.dat,this.fileHeader.mftOffset,this.fileHeader.mftSize,this.readMFTHeader)},n.prototype.readMFTHeader=function(e){this.mft=e.readStruct(i);e.position;var t=this.mft.nbOfEntries;this.mft.entryDict={offset_0:new Uint32Array(t),offset_1:new Uint32Array(t),offset:new Float64Array(t),size:new Uint32Array(t),compressed:new Uint16Array(t)},this.logger.log(T3D.Logger.TYPE_DEBUG,"reading MFT entries");for(var a=0;a<t-1;a++)this.mft.entryDict.offset_0[a]=e.readUint32(),this.mft.entryDict.offset_1[a]=e.readUint32(),this.mft.entryDict.size[a]=e.readUint32(),this.mft.entryDict.compressed[a]=e.readUint16(),this.mft.entryDict.offset[a]=f.arr32To64([this.mft.entryDict.offset_0[a],this.mft.entryDict.offset_1[a]]),e.seek(e.position+10);var r=f.arr32To64([this.mft.entryDict.offset_0[1],this.mft.entryDict.offset_1[1]]),n=this.mft.entryDict.size[1];this.loadFilePart(this.dat,r,n,this.readMFTIndexFile)},n.prototype.readMFTIndexFile=function(e,t){var a=t/8,r=new Uint32Array(a),n=new Uint32Array(a),i=new Uint32Array(a),o=new Uint32Array(a);this.mft.baseToMft=new Uint32Array(2e6),this.mft.fileToMft=new Uint32Array(2e6);for(var s=0;s<a;s++)r[s]=e.readUint32(),n[s]=e.readUint32();this.mft.id2index={ids:r,mftIndices:n};for(s=0;s<a;s++)if(0!=r[s]||0!=n[s]){var l=n[s],d={fileId:o[l],baseId:i[l]};if(0==d.baseId?d.baseId=r[s]:0==d.fileId&&(d.fileId=r[s]),0<d.baseId&&0<d.fileId&&d.baseId>d.fileId){var f=d.baseId;d.baseId=d.fileId,d.fileId=f}this.mft.baseToMft[d.baseId]=l,o[this.mft.fileToMft[d.fileId]=l]=d.fileId,i[l]=d.baseId}this.mft.m_entryToId={baseId:i,fileId:o},this.logger.log(T3D.Logger.TYPE_DEBUG,"Finished indexing MFT ",this.mft),this.onFullyLoaded&&this.onFullyLoaded()},n.prototype.loadFileList=function(){var e=this.dat,t="fileList_"+this.version+"."+e.name+"_"+e.lastModified+"_"+e.size,a=localStorage.getItem(t);if(!a)return null;try{return JSON.parse(a)}catch(e){}return null},n.prototype.loadMapList=function(){var e=this.dat,t="mapList_"+this.version+"."+e.name+"_"+e.lastModified+"_"+e.size,a=localStorage.getItem(t);if(!a)return null;try{return JSON.parse(a)}catch(e){}return null},n.prototype.storeFileList=function(e,t){var a=JSON.stringify(t),r="fileList_"+this.version+"."+e.name+"_"+e.lastModified+"_"+e.size;localStorage.setItem(r,a)},n.prototype.storeMapList=function(e,t){var a="mapList_"+this.version+"."+e.name+"_"+e.lastModified+"_"+e.size;localStorage.setItem(a,JSON.stringify(t))},n.prototype.readFileListAsync=function(t){var a=this,e=this.mft.id2index.mftIndices,r=f.sort_unique(e,function(e,t){return a.mft.entryDict.offset[e]-a.mft.entryDict.offset[t]}),n=r.length;this.logger.log(T3D.Logger.TYPE_DEBUG,"Scanning ",n,"files");this.listFiles(r,null,0,n,8,function(e){a.fileListeners=[],a.storeFileList(a.dat,e),t(e)})},n.prototype.readMapListAsync=function(e,a){var o=this,r=this.dat,n=[],s=(new Date).getTime();this.logger.log(T3D.Logger.TYPE_PROGRESS,"Finding maps (first visit only)","initializing"),e?n=this.mft.id2index.mftIndices:l.maps.forEach(function(e){e.maps.forEach(function(e){var t=e.fileName.split(".")[0],a=o.getFileIndex(t);n.push(a)})});var t=f.sort_unique(n,function(e,t){return o.mft.entryDict.offset[e]-o.mft.entryDict.offset[t]}),i=t.length;this.logger.log(T3D.Logger.TYPE_DEBUG,"Scanning ",i," files for maps..."),this.listFiles(t,"mapc",0,i,8,function(e){var t=(new Date).getTime()-s;o.logger.log(T3D.Logger.TYPE_DEBUG,"Time elapsed ",Math.round(.001*t)," seconds"),o.fileListeners=[];var i={maps:[]};e.mapc&&e.mapc.forEach(function(e){var a=o.mft.m_entryToId.baseId[e+1],r="",n="";l.maps.forEach(function(t){t.maps.forEach(function(e){0==r.length&&0<=e.fileName.indexOf(a+".")&&(r=e.name,n=t.name)})}),0==r.length&&(r="Unknown map "+a),0==n.length&&(n="Unknown maps");var t=null;i.maps.forEach(function(e){e.name==n&&(t=e)}),t||(t={name:n,maps:[]},i.maps.push(t)),t.maps.push({fileName:a,name:r})}),o.storeMapList(r,i),a(i)})},n.prototype.listFiles=function(o,s,l,e,d,f){for(var u=this,h=l+e,m=0,c=100/Math.min(e,o.length-l),g=0,p={},v=function(a){if(a%d==0){var e=Math.min(100,Math.floor((a-l)*c));m!=e&&(u.logger.log(T3D.Logger.TYPE_PROGRESS,"Find type",e),m=e)}if(a>=o.length||h<=a)return u.logger.log(T3D.Logger.TYPE_DEBUG,"Thread ",a%d+" done"),void(++g==d&&f(p));var r=o[a];if(u.mft.entryDict.compressed[r]){var n=r,t=u.mft.entryDict.offset[r],i=u.mft.entryDict.size[r];i<32?v(a+d):u.loadFilePart(u.dat,t,Math.min(i,2e3),function(e,t){u.inflate(e,t,n,function(e){!function(e,t,a){if(!e)return u.logger.log(T3D.Logger.TYPE_WARNING,"No infalted data for entry"),v(t+d);var r,n=new DataStream(e),i=n.readCString(4);r="ATEX"==i||"ATEC"==i||"ATEP"==i||"ATET"==i||"ATEU"==i||"ATTX"==i?"Texture":0==i.indexOf("PF")?new y(n,0,!0).header.type:0==i.indexOf("MZ")?"Binary":"strs"==i?"String":"Unknown";s&&r!=s||(p[r]||(p[r]=[]),p[r].push(a)),v(t+d)}(e,a,r)},!1,32)})}else v(a+d)},t=0;t<d;t++)v(l+t)},n.prototype.getFileIndex=function(e){var t=-1;return e=parseInt(e),-1!=(t=this.mft.m_entryToId.baseId.indexOf(e))?t-1:-1!=(t=this.mft.m_entryToId.fileId.indexOf(e))?t-1:t},n.prototype.loadTextureFile=function(e,t){this.loadFile(e,t,!0)},n.prototype.loadFile=function(e,a,r,n){var i=this,t=this.getFileIndex(e),o=t;if(o<=0)return i.logger.log(T3D.Logger.TYPE_WARNING,"Could not find file with baseId ",e),void a(null);var s=f.arr32To64([this.mft.entryDict.offset_0[o],this.mft.entryDict.offset_1[o]]),l=this.mft.entryDict.size[o];if(!this.mft.entryDict.compressed[o])return i.logger.log(T3D.Logger.TYPE_WARNING,"File is NOT compressed, skipping"),void a(null);var d=t;this.loadFilePart(this.dat,s,l,function(e,t){n?a(e):i.inflate(e,t,d,a,r)})},n.prototype.inflate=function(e,t,a,r,n,i){var o=e.buffer;if(i||(i=1),o.byteLength<12)return this.logger.log(T3D.Logger.TYPE_WARNING,"not inflating, length is too short ("+o.byteLength+")",a),void r(null);123350!=a&&123409!=a&&123408!=a?this.fileListeners[a]?this.fileListeners[a].push(r):(this.fileListeners[a]=[r],this.NaClInflater.postMessage([a,o,!0===n,i])):r(null)},n.prototype.loadFilePart=function(e,t,r,n){var i=this,a=new FileReader;a.onerror=function(e){},a.onload=function(e){var t=e.target.result,a=new DataStream(t);a.endianness=DataStream.LITTLE_ENDIAN,n.call(i,a,r)};var o=t,s=o+r;a.readAsArrayBuffer(e.slice(o,s))},t.exports=n},{"../MapFileList":3,"../format/definition/ANDAT":13,"../format/definition/MFT":14,"../format/file/GW2File.js":16,"../util/MathUtils.js":18}],2:[function(e,t,a){var r={TYPE_ERROR:4,TYPE_WARNING:3,TYPE_MESSAGE:2,TYPE_PROGRESS:1,TYPE_DEBUG:0};r.logFunctions=new Array(5),r.log=function(){if(0!=arguments.length){var e=r.argsToArr(arguments);1==e.length&&e.unshift(r.TYPE_MESSAGE);var t=Math.max(0,Math.min(r.logFunctions.length,e.shift()));r.logFunctions[t].apply(this,e)}},r.argsToArr=function(e){for(var t=new Array(e.length),a=0;a<t.length;++a)t[a]=e[a];return t},r.logFunctions[r.TYPE_ERROR]=function(){console.error.apply(console,arguments)},r.logFunctions[r.TYPE_WARNING]=function(){console.warn.apply(console,arguments)},r.logFunctions[r.TYPE_MESSAGE]=function(){console.log.apply(console,arguments)},r.logFunctions[r.TYPE_PROGRESS]=function(){var e=r.argsToArr(arguments);e.unshift("Progress: "),console.log.apply(console,e)},r.logFunctions[r.TYPE_DEBUG]=function(){var e=r.argsToArr(arguments);console.debug.apply(console,e)},t.exports=r},{}],3:[function(e,t,a){t.exports={maps:[{name:"Heart of Maguuma",maps:[{fileName:"1151420.data",name:"HoT BWE3 Raid"},{fileName:"969663.data",name:"Verdant Brink"},{fileName:"1262460.data",name:"HoT Personal story finale"}]},{name:"Maguuma Wastes",maps:[{fileName:"836211.data",name:"Dry top (Past)"},{fileName:"861770.data",name:"Dry top (Present)"},{fileName:"909361.data",name:"The Silverwastes v1"},{fileName:"996202.data",name:"The Silverwastes v2"}]},{name:"Other",maps:[{fileName:"184799.data",name:"Empty Plane v1"},{fileName:"197562.data",name:"Empty Plane v2"},{fileName:"875614.data",name:"Unknown Mists Platforms"},{fileName:"908730.data",name:"Glint's Lair"},{fileName:"969964.data",name:"Unknown Airship in tree"},{fileName:"wizard.data.zip",name:"Wizard's tower ZIP"},{fileName:"WizardsTowerSanctumCayLAKrytaMap.data",name:"Wizard's tower PARM"},{fileName:"vale.data.zip",name:"Fortunes Vale ZIP"},{fileName:"FortunesVale.data",name:"Fortunes Vale PARM"}]},{name:"PvP",maps:[{fileName:"871093.data",name:"Original Stronghold"},{fileName:"870987.data",name:"Champion's Dusk"},{fileName:"197249.data",name:"Heart of the Mists"},{fileName:"197402.data",name:"The Battle of Khylo"},{fileName:"197545.data",name:"Forest of Niflhel"},{fileName:"376916.data",name:"Legacy of the Foefire"},{fileName:"467374.data",name:"Raid on the Capricorn"},{fileName:"520609.data",name:"Temple of the Silent Storm"},{fileName:"677968.data",name:"Skyhammer"},{fileName:"791564.data",name:"Courtyard"},{fileName:"556199.data",name:"Spirit Watch"},{fileName:"506539.data",name:"Reaper's Rumble"},{fileName:"529718.data",name:"Snowball Mayhem"},{fileName:"595582.data",name:"Dragon Ball Arena"},{fileName:"617120.data",name:"Aspect Arena"}]},{name:"WvW",maps:[{fileName:"195806.data",name:"Eternal Battlegrounds"},{fileName:"641501.data",name:"Borderlands"},{fileName:"736241.data",name:"Edge of the Mists"}]},{name:"Dungeons",maps:[{fileName:"189364.data",name:"Ascalonian Catacombs"},{fileName:"275474.data",name:"Sorrow's Embrace"},{fileName:"276520.data",name:"Honor of the Waves"},{fileName:"284039.data",name:"Citadel of Flame"},{fileName:"287214.data",name:"Caudecus's Manor"},{fileName:"291284.data",name:"Twilight Arbor (Past)"},{fileName:"645968.data",name:"Twilight Arbor (Present)"},{fileName:"293606.data",name:"Crucible of Eternity"},{fileName:"473930.data",name:"The Ruined City of Arah"},{fileName:"473765.data",name:"Arah - Story"},{fileName:"580061.data",name:"Molten Facility"},{fileName:"595722.data",name:"Aetherblade Retreat"}]},{name:"The Mists (PvE)",maps:[{fileName:"519839.data",name:"Fractals of the Mists"},{fileName:"697450.data",name:"Thaumanova Reactor"},{fileName:"506592.data",name:"Ascent to Madness"},{fileName:"506670.data",name:"Mad King's Labyrinth (Past)"},{fileName:"662436.data",name:"Mad King's Labyrinth (Present)"},{fileName:"506739.data",name:"Mad King's Clock Tower"}]},{name:"Shiverpeak Mountains",maps:[{fileName:"187611.data",name:"Wayfarer Foothills"},{fileName:"568778.data",name:"Cragstead"},{fileName:"197122.data",name:"Hoelbrak"},{fileName:"186397.data",name:"Snowden Drifts"},{fileName:"275155.data",name:"Dredgehaunt Cliffs"},{fileName:"276252.data",name:"Frostgorge Sound"},{fileName:"277587.data",name:"Lornar's Pass"},{fileName:"278717.data",name:"Timberline Falls (Past)"},{fileName:"846866.data",name:"Timberline Falls (Present)"}]},{name:"Far Shiverpeaks",maps:[{fileName:"295282.data",name:"Eye of the North"}]},{name:"Ascalon",maps:[{fileName:"188591.data",name:"Plains of Ashford"},{fileName:"190490.data",name:"Diessa Plateau"},{fileName:"196585.data",name:"Black Citadel"},{fileName:"280025.data",name:"Blazeridge Steppes"},{fileName:"281313.data",name:"Fireheart Rise"},{fileName:"282668.data",name:"Iron Marches"},{fileName:"283574.data",name:"Fields of Ruin"}]},{name:"Kryta",maps:[{fileName:"191000.data",name:"Lion's Arch"},{fileName:"191265.data",name:"Divinity's Reach"},{fileName:"705746.data",name:"Divinity's Reach"},{fileName:"193081.data",name:"North of Divinity's Reach"},{fileName:"192711.data",name:"Queensdale"},{fileName:"194288.data",name:"Kessex Hills v1"},{fileName:"672138.data",name:"Kessex Hills v2"},{fileName:"861815.data",name:"Kessex Hills v3"},{fileName:"286945.data",name:"Bloodtide Coast"},{fileName:"287870.data",name:"Harathi Hinterlands"},{fileName:"289176.data",name:"Gendarran Fields"},{fileName:"295005.data",name:"Chantry of Secrets"},{fileName:"294938.data",name:"Claw Island"},{fileName:"520479.data",name:"Southsun Cove"},{fileName:"622681.data",name:"The Crown Pavilion"},{fileName:"679089.data",name:"Tower of Nightmares"}]},{name:"Maguuma Jungle",maps:[{fileName:"195149.data",name:"Caledon Forest"},{fileName:"195493.data",name:"Metrica Province"},{fileName:"922320.data",name:"Metrica Province Instance"},{fileName:"198076.data",name:"The Grove"},{fileName:"198272.data",name:"Rata Sum"},{fileName:"291064.data",name:"Mount Maelstrom"},{fileName:"292254.data",name:"Sparkfly Fen"},{fileName:"293307.data",name:"Brisban Wildlands"},{fileName:"636133.data",name:"SAB Hub"},{fileName:"635555.data",name:"SAB World 1"},{fileName:"635960.data",name:"SAB World 2"},{fileName:"606255.data",name:"Zephyr Sanctum"},{fileName:"605983.data",name:"Sanctum Sprint"},{fileName:"606030.data",name:"Basket Brawl"}]},{name:"Ruins of Orr",maps:[{fileName:"284829.data",name:"Straits of Devastation"},{fileName:"285089.data",name:"Malchor's Leap"},{fileName:"285634.data",name:"Cursed Shore"},{fileName:"295179.data",name:"Cathedral of Hidden Depths"},{fileName:"295962.data",name:"A Light in the Darkness"}]},{name:"Enchanted Snow Globe",maps:[{fileName:"529896.data",name:"Tixx's Infinirarium"},{fileName:"529945.data",name:"Winter Wonderland"}]},{name:"Historical Maps",maps:[{fileName:"814803.data",name:"Lion's Arch"},{fileName:"579383.data",name:"Skyhammer"},{fileName:"569756.data",name:"SAB"},{fileName:"122695.data",name:"Empty Plane"},{fileName:"127888.data",name:"Diessa Plateau"},{fileName:"128151.data",name:"Divinity's Reach"},{fileName:"129524.data",name:"Queensdale"},{fileName:"129834.data",name:"North of Divinity's Reach"},{fileName:"130970.data",name:"Kessex Hills"},{fileName:"131235.data",name:"Eternal Battlegrounds"},{fileName:"131574.data",name:"Borderlands"},{fileName:"131944.data",name:"Black Citadel"},{fileName:"132434.data",name:"Hoelbrak"},{fileName:"132570.data",name:"Heart of the Mists"},{fileName:"132710.data",name:"The Battle of Khylo"},{fileName:"132837.data",name:"Forest of Niflhel"},{fileName:"132853.data",name:"Empty Box"},{fileName:"124093.data",name:"Snowden Drifts"},{fileName:"125199.data",name:"Wayfarer Foothills"},{fileName:"126118.data",name:"Plains of Ashford"},{fileName:"126840.data",name:"Ascalonian Catacombs"}]}]}},{}],4:[function(e,t,a){function l(){}LocalReader=e("./LocalReader/LocalReader.js"),t.exports=l;var r,d="1.0.4",f="modules/nacl/t3dgwtools.nmf";l.version=d,l.GW2File=e("./format/file/GW2File"),l.GW2Chunk=e("./format/file/GW2Chunk"),l.DataRenderer=e("./dataRenderer/DataRenderer"),l.EnvironmentRenderer=e("./dataRenderer/EnvironmentRenderer"),l.HavokRenderer=e("./dataRenderer/HavokRenderer"),l.PropertiesRenderer=e("./dataRenderer/PropertiesRenderer"),l.ModelRenderer=e("./dataRenderer/ModelRenderer"),l.TerrainRenderer=e("./dataRenderer/TerrainRenderer"),l.ZoneRenderer=e("./dataRenderer/ZoneRenderer"),l.StringRenderer=e("./dataRenderer/StringRenderer"),l.Logger=e("./Logger"),l.MapFileList=e("./MapFileList"),l.MaterialUtils=e("./util/MaterialUtils.js"),l.MathUtils=e("./util/MathUtils.js"),l.ParserUtils=e("./util/ParserUtils.js"),l.RenderUtils=e("./util/RenderUtils.js"),l.getLocalReader=function(e,t,a,r,n){if(n&&void 0===navigator.mimeTypes["application/x-nacl"]){var i=new Worker(n);(s=new LocalReader(e,d,r)).connectInflater(i,i)}else{var o=document.createElement("div");o.setAttribute("id","pNaClListener");var s,l=document.createElement("embed");l.setAttribute("type","application/x-pnacl"),l.style.position="absolute",l.style.height=0,l.style.width=0,l.setAttribute("src",a||f),o.appendChild(l),document.body.appendChild(o),(s=new LocalReader(e,d,r)).connectInflater(l,o)}return s.parseHeaderAsync(t),s},l.getFileListAsync=function(e,t){var a=e.loadFileList();a?t(a):e.readFileListAsync(t)},l.getMapListAsync=function(e,t,a){if(a)e.readMapListAsync(!0,t);else{var r=e.loadMapList();r?t(r):e.readMapListAsync(!1,t)}},l.renderMapContentsAsync=function(n,e,i,o,t){var s={};parseInt(e)?n.loadFile(e,function(e){var t=new DataStream(e,0,DataStream.LITTLE_ENDIAN),a=new l.GW2File(t,0),r=function(e){e<i.length?l.runRenderer(i[e].renderClass,n,Object.assign(i[e].settings,{mapFile:a}),s,r.bind(this,e+1)):o(s)};r(0)}):(t||l.Logger).log(l.Logger.TYPE_ERROR,"Map id must be an integer!, was:",e)},l.runRenderer=function(e,t,a,r,n){new e(t,a,r).renderAsync(n)},l.getContextValue=function(e,t,a,r){var n=e[t.name];return n&&n[a]?n[a]:r},l.hasWebGL=function(e){if(window.WebGLRenderingContext){for(var t=document.createElement("canvas"),a=["webgl","experimental-webgl","moz-webgl","webkit-3d"],r=!1,n=0;n<4;n++)try{if((r=t.getContext(a[n]))&&"function"==typeof r.getParameter)return!e||{name:a[n],gl:r}}catch(e){}return!1}return!1},r=0,-1<navigator.userAgent.toLowerCase().indexOf("chrome")||(l.Logger.log(l.Logger.TYPE_ERROR,"T3D inflation requires Google Chrome."),r++),"undefined"==typeof DataStream&&(l.Logger.log(l.Logger.TYPE_ERROR,"T3D core functionality requires DataStream library."),r++),"undefined"==typeof THREE&&(l.Logger.log(l.Logger.TYPE_WARNING,"T3D mesh generation requires three.js library."),r++),r<1&&l.Logger.log(l.Logger.TYPE_MESSAGE,"Tyria 3D API v"+l.version+" initialized.")},{"./LocalReader/LocalReader.js":1,"./Logger":2,"./MapFileList":3,"./dataRenderer/DataRenderer":5,"./dataRenderer/EnvironmentRenderer":6,"./dataRenderer/HavokRenderer":7,"./dataRenderer/ModelRenderer":8,"./dataRenderer/PropertiesRenderer":9,"./dataRenderer/StringRenderer":10,"./dataRenderer/TerrainRenderer":11,"./dataRenderer/ZoneRenderer":12,"./format/file/GW2Chunk":15,"./format/file/GW2File":16,"./util/MaterialUtils.js":17,"./util/MathUtils.js":18,"./util/ParserUtils.js":19,"./util/RenderUtils.js":20}],5:[function(e,t,a){var d=e("../format/file/GW2File"),r=t.exports=function(e,t,a,r){this.localReader=e,(this.settings=t)||(t={}),this.context=a,this.context[this.constructor.name]={},this.logger=r||T3D.Logger};r.prototype.getOutput=function(e){return this.context[e?e.name:this.constructor.name]},r.prototype.renderAsync=function(s){var l=this;this.localReader.loadFile(this.settings.id,function(e){l.getOutput().fileId=l.settings.id,l.getOutput().rawData=e;for(var t=new Uint8Array(e),a=[],r=Math.min(t.length,1e4),n=0;65535*n<r;n++)a.push(String.fromCharCode.apply(null,t.subarray(65535*n,65535*(n+1))));r<t.length&&a.push("T3D Ignored the last "+(t.length-r)+" bytes when generating this raw output"),l.getOutput().rawString=a.join();var i=new DataStream(e),o=i.readCString(4);"ATEX"==o||"ATEC"==o||"ATEP"==o||"ATET"==o||"ATEU"==o||"ATTX"==o?l.localReader.loadTextureFile(l.settings.id,function(e,t,a,r){var n={data:new Uint8Array(e),width:a,height:r};l.getOutput().image=n,s()}):(0==o.indexOf("PF")?l.getOutput().file=new d(i,0):l.getOutput().file=null,s())})}},{"../format/file/GW2File":16}],6:[function(e,t,a){var d=e("../util/RenderUtils"),r=e("./DataRenderer");function n(l,e,t,a){r.call(this,l,e,t,a),this.mapFile=this.settings.mapFile,this.getMat=function(e){return new THREE.MeshBasicMaterial({map:e,side:THREE.BackSide,fog:!1,depthWrite:!1})},this.loadTextureWithFallback=function(e,a,t,r,n){var i=this;function o(t){e.forEach(function(e){a[e]=t})}function s(){o(i.getMat(THREE.ImageUtils.loadTexture(r)))}o(i.getMat(d.loadLocalTexture(l,t,null,n,function(){setTimeout(s,1)})))},this.getHazeColor=function(e){var t=e&&e.dataGlobal.haze;return!t||t.length<=0?[190,160,60]:t[0].farColor},this.parseLights=function(e){var n=this;n.getOutput().lights=[];var r,t=e?e.dataGlobal.lighting:[{lights:[],backlightIntensity:1,backlightColor:[255,255,255]}],i=!1;t.forEach(function(e,t){if(!i){if(e.lights.forEach(function(e,t){i=!0;var a=new THREE.Color(e.color[2]/255,e.color[1]/255,e.color[0]/255),r=new THREE.DirectionalLight(a.getHex(),e.intensity);r.position.set(-e.direction[0],e.direction[2],e.direction[1]).normalize(),e.intensity,n.getOutput().lights.push(r)}),!e.lights||0==e.lights.length){[[0,1,0,.3],[1,2,1,.3],[-1,-2,-1,.3]].forEach(function(e){var t=new THREE.Color(1,1,1),a=e[3],r=new THREE.DirectionalLight(t.getHex(),a);r.position.set(e[0],e[1],e[2]).normalize(),a,n.getOutput().lights.push(r)})}e.backlightIntensity=e.backlightIntensity;var a=new THREE.Color(e.backlightIntensity*(255-e.backlightColor[2])/255,e.backlightIntensity*(255-e.backlightColor[1])/255,e.backlightIntensity*(255-e.backlightColor[0])/255);r=new THREE.AmbientLight(a)}});var a=0;r&&(a=r.color.r+r.color.g+r.color.b,this.getOutput().lights.push(r)),this.getOutput().hasLight=i||0<a},this.parseSkybox=function(e,t,a){this.getOutput().skyElements=[];var r=this.environmentChunkData&&this.environmentChunkData.dataGlobal.skyModeTex[0];r||(r={texPathNE:1930687,texPathSW:193069,texPathT:193071});var n=t.rect,i=Math.abs(n.x1-n.x2),o=Math.abs(n.y1-n.y2),s=(Math.max(i,o),[]);this.loadTextureWithFallback([1,4],s,r.texPathNE+1,"img/193068.png",a),this.loadTextureWithFallback([0,5],s,r.texPathSW+1,"img/193070.png",a),this.loadTextureWithFallback([2],s,r.texPathT+1,"img/193072.png",a),s[3]=new THREE.MeshBasicMaterial({visible:!1});var l=new THREE.BoxGeometry(1024,512,1024);l.faceVertexUvs[0].forEach(function(e,t){var a=Math.floor(t/2);0==a||1==a?e.forEach(function(e){e.x=1-e.x,e.y/=2,e.y+=.5}):5==a||4==a?e.forEach(function(e){e.y/=-2,e.y+=.5}):e.forEach(function(e){e.x=1-e.x})}),l.uvsNeedUpdate=!0;var d=new THREE.MeshFaceMaterial(s),f=new THREE.Mesh(l,d);f.translateY(256),this.getOutput().skyElements.push(f)}}((n.prototype=Object.create(r.prototype)).constructor=n).prototype.renderAsync=function(e){var t=this.mapFile.getChunk("env").data,a=this.mapFile.getChunk("parm").data,r=this.getHazeColor(t),n=256*r[2]*256+256*r[1]+r[0];this.getOutput().hazeColor=r,this.parseLights(t),this.parseSkybox(t,a,n),e()},t.exports=n},{"../util/RenderUtils":20,"./DataRenderer":5}],7:[function(e,t,a){var n=e("./DataRenderer");function r(e,t,a,r){n.call(this,e,t,a,r),this.mapFile=this.settings.mapFile,this.lastP=-1,this.seed=1,this.meshes=[],this.renderModels=function(e,t,a){var r;r=this.settings&&this.settings.visible?new THREE.MeshNormalMaterial({side:THREE.DoubleSide}):new THREE.MeshBasicMaterial({visible:!1}),this.parseAllModels(e,r,t,200,0,a)},this.getCollisionsForAnimation=function(e,t){for(var a=[],r=0;r<e.collisionIndices.length;r++){var n=e.collisionIndices[r],i=t[n];i.index=n,a.push(i)}return a},this.parseAllModels=function(e,t,a,r,n,i){for(var o=n;o<n+r&&o<e.length;o++){var s=Math.round(100*o/e.length);s!=this.lastP&&(this.logger.log(T3D.Logger.TYPE_PROGRESS,"Loading Collision Models ("+a+")",s),this.lastP=s);for(var l=this.animationFromGeomIndex(e[o].geometryIndex,this.geometries,this.animations),d=this.getCollisionsForAnimation(l,this.havokChunkData.collisions),f=0;f<d.length;f++){var u=d[f];this.renderMesh(u,e[o],t)}}o<e.length?window.setTimeout(this.parseAllModels.bind(this,e,t,a,r,n+r,i),10):i()},this.animationFromGeomIndex=function(e,t,a){var r=t[e].animations.length;return a[t[e].animations[r-1]]},this.renderMesh=function(e,t,a){var r=t.translate,n=t.rotate,i=32*t.scale,o=this.parseHavokMesh(e,a);o.position.set(r[0],-r[2],-r[1]),i&&o.scale.set(i,i,i),n&&(o.rotation.order="ZXY",o.rotation.set(n[0],-n[2],-n[1])),this.getOutput().meshes.push(o)},this.seedRandom=function(){var e=1e4*Math.sin(this.seed++);return e-Math.floor(e)},this.parseHavokMesh=function(e,t){var a=e.index;if(this.meshes[a])return this.meshes[a].clone();for(var r=new THREE.Geometry,n=0;n<e.vertices.length;n++){var i=e.vertices[n];r.vertices.push(new THREE.Vector3(i[0],i[2],-i[1]))}for(n=0;n<e.indices.length;n+=3){var o=e.indices[n],s=e.indices[n+1],l=e.indices[n+2];o<=e.vertices.length&&s<=e.vertices.length&&l<=e.vertices.length?r.faces.push(new THREE.Face3(o,s,l)):this.logger.log(T3D.Logger.TYPE_ERROR,"Errorus index in havok model geometry.")}return r.computeFaceNormals(),this.meshes[a]=new THREE.Mesh(r,t),this.meshes[a]}}((r.prototype=Object.create(n.prototype)).constructor=r).prototype.renderAsync=function(e){var t=this;this.havokChunkData=this.mapFile.getChunk("havk").data,this.getOutput().boundingBox=this.havokChunkData.boundsMax,this.meshes=[],this.getOutput().meshes=[];var a=this.havokChunkData.propModels,r=this.havokChunkData.zoneModels,n=this.havokChunkData.obsModels;n.forEach(function(e){e.scale=1}),this.geometries=this.havokChunkData.geometries,this.animations=this.havokChunkData.animations;var i=function(){t.renderModels(n,"obs",e)};t.renderModels(a,"prop",function(){t.renderModels(r,"zone",i)})},t.exports=r},{"./DataRenderer":5}],8:[function(e,t,a){var o=e("../util/RenderUtils"),n=e("./DataRenderer");function r(e,t,a,r){n.call(this,e,t,a,r)}((r.prototype=Object.create(n.prototype)).constructor=r).prototype.renderAsync=function(r){var n=this,e=this.settings.id,i={};n.getOutput().meshes=[],o.getMeshesForFilename(e,65280,n.localReader,i,{},!0,function(e,t,a){e&&e.forEach(function(e){e.boundingSphere=a,n.getOutput().meshes.push(e)}),i={},r()})},t.exports=r},{"../util/RenderUtils":20,"./DataRenderer":5}],9:[function(e,t,a){var l=e("../util/RenderUtils"),n=e("./DataRenderer");function r(e,t,a,r){n.call(this,e,t,a,r),this.mapFile=this.settings.mapFile}((r.prototype=Object.create(n.prototype)).constructor=r).prototype.renderAsync=function(a){var h=this;h.getOutput().meshes=[];var e=this.mapFile.getChunk("prp2").data;if(e){var r=e.propArray,t=e.propAnimArray,n=e.propInstanceArray,i=e.propMetaArray;r=r.concat(t).concat(n).concat(i),h.meshCache={},h.textureCache={};var o=-1,m=function(d){if(d>=r.length)return h.meshCache={},h.textureCache={},void a();var e=Math.round(1e3*d/r.length);if(o!=(e/=10)){var t=e+(e.toString().indexOf(".")<0?".0":"");h.logger.log(T3D.Logger.TYPE_PROGRESS,"Loading 3D Models (Props)",t),o=e}var f=r[d],u=function(e,t,a,r,n){var i=0!=r.lod2?r.lod2:e.lodOverride[1];if(0==e.flags&&(i=0),n&&(e=new THREE.Mesh(e.geometry,e.material)),e.updateMatrix(),e.matrixAutoUpdate=!1,t[i])t[i].add(e);else{var o=new THREE.Group;o.updateMatrix(),o.matrixAutoUpdate=!1,o.add(e),t[i]=o,a.addLevel(o,i)}return i};l.getMeshesForFilename(f.filename,f.color,h.localReader,h.meshCache,h.textureCache,!1,function(e,t,a){var n,r,i,o,s,l;e&&(n=e,r=t,i=a,o={},s=new THREE.LOD,l=0,n.forEach(function(e){l=Math.max(l,u(e,o,s,f,r))}),f.rotation&&(s.rotation.order="ZXY",s.rotation.set(f.rotation[0],-f.rotation[2],-f.rotation[1])),s.scale.set(f.scale,f.scale,f.scale),s.position.set(f.position[0],-f.position[2],-f.position[1]),s.boundingSphereRadius=(i&&i.radius?i.radius:1)*f.scale,s.updateMatrix(),s.matrixAutoUpdate=!1,h.getOutput().meshes.push(s),f.transforms&&f.transforms.forEach(function(e){var t={},a=new THREE.LOD,r=0;n.forEach(function(e){r=Math.max(r,u(e,t,a,f,!0))}),e.rotation&&(a.rotation.order="ZXY",a.rotation.set(e.rotation[0],-e.rotation[2],-e.rotation[1])),a.scale.set(e.scale,e.scale,e.scale),a.position.set(e.position[0],-e.position[2],-e.position[1]),a.updateMatrix(),a.matrixAutoUpdate=!1,a.boundingSphereRadius=(i&&i.radius?i.radius:1)*f.scale,h.getOutput().meshes.push(a)})),m(d+1)})};m(0)}else renderCallback()},r.prototype.getFileIdsAsync=function(a){var r=[],e=this.mapFile.getChunk("prp2").data,n=e.propArray,t=e.propAnimArray,i=e.propInstanceArray,o=e.propMetaArray;n=n.concat(t).concat(i).concat(o);var s=function(t){if(t>=n.length)a(r);else{t%100==0&&this.logger.log(T3D.Logger.TYPE_MESSAGE,"getting ids for entry",t,"of",n.length);var e=n[t];l.getFilesUsedByModel(e.filename,localReader,function(e){r=r.concat(e),s(t+1)})}};s(0)},t.exports=r},{"../util/RenderUtils":20,"./DataRenderer":5}],10:[function(e,t,a){e("../util/RenderUtils");var n=e("./DataRenderer");function r(e,t,a,r){n.call(this,e,t,a,r)}((r.prototype=Object.create(n.prototype)).constructor=r).prototype.renderAsync=function(s){var l=this;this.settings.id;this.getOutput().strings=[],this.localReader.loadFile(this.settings.id,function(e){var t=new DataStream(e),a=t.byteLength-2;t.seek(4);for(var r=["size","uint16","decryptionOffset","uint16","bitsPerSymbol","uint16"],n=0;6<a-t.position;){var i=t.readStruct(r);if(i.size-=6,0<i.size)if(!(0!=i.decryptionOffset||16!=i.bitsPerSymbol)){var o=t.readUCS2String(i.size/2);l.getOutput().strings.push({value:o,recid:n})}n++}t.seek(t.byteLength-2),l.getOutput().language=t.readUint16(),s()})},t.exports=r},{"../util/RenderUtils":20,"./DataRenderer":5}],11:[function(e,t,a){var B=e("../util/RenderUtils"),i=e("./DataRenderer"),d=e("../format/file/GW2File.js");function r(e,t,a,r,n){i.call(this,e,t,a,r,n),this.mapFile=this.settings.mapFile,this.drawWater=function(e){var t=t||new THREE.MeshBasicMaterial({color:6009320,wireframe:!1,opacity:.35});return t.transparent=!0,B.renderRect(e,0,t)},this.parseNumChunks=function(e){e.numChunksD_1=Math.sqrt(e.dims[0]*e.chunkArray.length/e.dims[1]),e.numChunksD_2=e.chunkArray.length/e.numChunksD_1},this.loadPagedImageCallback=function(r,e){var b=this;b.getOutput().terrainTiles=[];var t=new DataStream(e),a=new d(t,0).getChunk("pgtb"),n=a&&a.data;this.mapRect=null;var L=this.mapFile.getChunk("trn").data,C=this.mapFile.getChunk("parm").data,S=this.settings.anisotropy?this.settings.anisotropy:1;this.parseNumChunks(L);var P=L.numChunksD_1,i=L.numChunksD_2,H=L.materials.materials,U=L.materials.texFileArray,o=C.rect[2]-C.rect[0],s=C.rect[3]-C.rect[1],I=o/L.numChunksD_1*1,_=s/L.numChunksD_2*1,O=0,G=[],z=new THREE.MeshLambertMaterial({side:THREE.DoubleSide,color:6710886,shading:THREE.FlatShading}),W={};n&&n.strippedPages.forEach(function(e){if(e.layer<=1){var t=e.filename,a=(e.solidColor,e.coord),r=a[0]+","+a[1];if(1==e.layer&&(r+="-2"),!W[r]){var n=B.loadLocalTexture(b.localReader,t);n&&(n.anisotropy=S,n.wrapT=n.wrapS=THREE.RepeatWrapping),W[r]=n}}});var l=function(e,t){if(P<=e&&(e=0,t++),i<=t)return b.getOutput().water=b.drawWater(b.mapRect),b.getOutput().bounds=b.mapRect,void r();var a=Math.floor(100*(t*P+e)/(P*i));b.logger.log(T3D.Logger.TYPE_PROGRESS,"Loading Terrain",a),function(e,t){for(var a,r=t*P+e,n=Math.floor(e/4),i=Math.floor(t/4),o=H[r].loResMaterial.texIndexArray,s=(H[r].loResMaterial.materialFile,L.chunkArray[r],U[o[0]],e%4/4),l=.75-t%4/4,d=[],f=0;f<o.length/2;f++){var u=U[o[f]].filename;if(d.push(u),!W[u]){var h=B.loadLocalTexture(b.localReader,u);h&&(h.anisotropy=S,h.wrapT=h.wrapS=THREE.RepeatWrapping),W[u]=h}}var m=n+","+i,c=n+","+i+"-2",g={color:{r:1,g:1,b:1},near:0,far:0},p=b.getOutput(T3D.EnvironmentRenderer);p.hazeColor&&(g.color.r=p.hazeColor[2]/255,g.color.g=p.hazeColor[1]/255,g.color.b=p.hazeColor[0]/255);var v=THREE.UniformsUtils.merge([THREE.UniformsLib.lights]);v.fogColor={type:"v3",value:new THREE.Vector3(g.color.r,g.color.g,g.color.b)},v.fogNear={type:"f",value:g.near},v.fogFar={type:"f",value:g.far},v.uvScale={type:"v2",value:new THREE.Vector2(8,8)},v.offset={type:"v2",value:new THREE.Vector2(s,l)},v.texturePicker={type:"t",value:W[m]},v.texturePicker2={type:"t",value:W[c]},v.texture1={type:"t",value:W[d[0]]},v.texture2={type:"t",value:W[d[1]]},v.texture3={type:"t",value:W[d[2]]},v.texture4={type:"t",value:W[d[3]]},a=new THREE.ShaderMaterial({uniforms:v,vertexShader:"varying vec2 vUv;\r\nvarying vec3 vecNormal;\r\nvoid main()\r\n{\r\nvUv =  uv;\r\nvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\r\nvecNormal = (modelMatrix * vec4(normal, 0.0)).xyz;\r\ngl_Position = projectionMatrix * mvPosition;\r\n}",fragmentShader:"\r\nuniform vec3 fogColor;\r\nuniform float fogNear;\r\nuniform float fogFar;\r\nuniform vec2 uvScale;\r\nuniform vec2 offset;\r\nuniform sampler2D texturePicker;\r\nuniform sampler2D texturePicker2;\r\nuniform sampler2D texture1;\r\nuniform sampler2D texture2;\r\nuniform sampler2D texture3;\r\nuniform sampler2D texture4;\r\nuniform vec3 ambientLightColor;\r\n#if MAX_DIR_LIGHTS > 0\r\nuniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];\r\nuniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];\r\n#endif\r\nvarying vec2 vUv;\r\nvarying vec3 vecNormal;\r\nvec3 blend(\r\nvec4 texture1, float a1,\r\nvec4 texture2, float a2,\r\nvec4 texture3, float a3,\r\nvec4 texture4, float a4)\r\n{\r\nfloat depth = 2.0;\r\nfloat alphaMult = 1.0;\r\nfloat alphaAdd  = 0.0;\r\na1 *= 4.0;\r\na2 *= 4.0;\r\na3 *= 4.0;\r\na4 *= 4.0;\r\na1 =  a1+(1.5+texture1.a);\r\na2 =  a2+(1.5+texture2.a);\r\na3 =  a3+(1.5+texture3.a);\r\na4 =  a4+(1.5+texture4.a);\r\nfloat ma = max(a1,a2);\r\nma = max(ma,a3);\r\nma = max(ma,a4);\r\nma -= depth;\r\nfloat b1 = max(a1 - ma, 0.0);\r\nfloat b2 = max(a2 - ma, 0.0);\r\nfloat b3 = max(a3 - ma, 0.0);\r\nfloat b4 = max(a4 - ma, 0.0);\r\nreturn (\r\ntexture1.rgb * b1 +\r\ntexture2.rgb * b2 +\r\ntexture3.rgb * b3 +\r\ntexture4.rgb * b4 \r\n) / (b1 + b2 + b3 +b4);\r\n}\r\nvoid main( void ) {\r\nvec2 position = vUv*uvScale;\r\nfloat edge = 1.0/1024.0;\r\nvec2 compPos = edge +  (vUv*0.25 + offset)*(1.0-edge*2.0);\r\nvec4 tp1 = texture2D( texturePicker, compPos);\r\nvec4 tp2 = texture2D( texturePicker2, compPos);\r\nvec4 composite = tp1;\r\nvec4 t1 = texture2D( texture1, position );\r\nvec4 t2 = texture2D( texture2, position );\r\nvec4 t3 = texture2D( texture3, position );\r\nvec4 t4 = texture2D( texture4, position );\r\nvec3 color = blend(\r\nt1, tp1.a,\r\nt2, tp1.b,\r\nt3, tp1.g,\r\nt4, tp1.r\r\n);\r\ncolor *= 0.5+tp2.r;\r\ngl_FragColor = vec4(color,1.0);\r\nvec4 addedLights = vec4(ambientLightColor, 1.0);\r\n#if MAX_DIR_LIGHTS > 0\r\nfor(int l = 0; l < MAX_DIR_LIGHTS; l++) {\r\naddedLights.rgb += clamp(\r\ndot(-directionalLightDirection[l], vecNormal),\r\n0.0,\r\n1.0\r\n)\r\n* directionalLightColor[l];\r\n}\r\n#endif\r\ngl_FragColor *= addedLights;\r\nfloat depth = gl_FragCoord.z / gl_FragCoord.w;\r\nfloat fogFactor = smoothstep( fogNear, fogFar, depth );\r\ngl_FragColor.xyz = mix( gl_FragColor.xyz, fogColor.xyz, fogFactor );\r\n}",lights:!0}),G.push(a);for(var y=new THREE.PlaneBufferGeometry(I,_,32,32),E=0,R=0;R<35;R++)for(var T=0;T<35;T++)0!=T&&34!=T&&0!=R&&34!=R&&(y.attributes.position.array[3*E+2]=L.heightMapArray[O],E++),O++;var x,M=(new THREE.Matrix4).identity();M.elements[5]=-1,y.applyMatrix(M),y.computeFaceNormals(),x=new THREE.Mesh(y,z),(x=a.length?THREE.SceneUtils.createMultiMaterialObject(y,a):new THREE.Mesh(y,a)).rotation.set(Math.PI/2,0,0);var N=C.rect[0]+I/2,w=e*I;if(x.position.x=N+w,L.numChunksD_2%2==0){var F=C.rect[1]+_/2-0,D=t*_*1;x.position.z=D+F}else F=C.rect[1]-_/2+0,D=t*_*1,x.position.z=F+D;var k=x.position.x,A=x.position.z;b.mapRect||(b.mapRect={x1:k-I/2,x2:k+I/2,y1:A-_/2,y2:A+_/2}),b.mapRect.x1=Math.min(b.mapRect.x1,k-I/2),b.mapRect.x2=Math.max(b.mapRect.x2,k+I/2),b.mapRect.y1=Math.min(b.mapRect.y1,A-_/2),b.mapRect.y2=Math.max(b.mapRect.y2,A+_/2),x.updateMatrix(),x.updateMatrixWorld(),b.getOutput().terrainTiles.push(x)}(e,t),setTimeout(l,1,e+1,t)};l(0,0)}}((r.prototype=Object.create(i.prototype)).constructor=r).prototype.renderAsync=function(e){var t=this.mapFile.getChunk("trn").data.materials.pagedImage;this.localReader.loadFile(t,this.loadPagedImageCallback.bind(this,e))},r.prototype.getFileIdsAsync=function(e){var t=this.mapFile.getChunk("trn"),a=this.mapFile.getChunk("pimg"),r=[];return(a&&a.data).strippedPages.forEach(function(e){e.layer<=1&&0<e.filename&&r.push(e.filename)}),t.data.materials.texFileArray.forEach(function(e){0<e.filename&&r.push(e.filename)}),r},t.exports=r},{"../format/file/GW2File.js":16,"../util/RenderUtils":20,"./DataRenderer":5}],12:[function(e,t,a){var l=e("../util/RenderUtils"),n=e("./DataRenderer");function r(e,t,a,r){n.call(this,e,t,a,r),this.mapFile=this.settings.mapFile,this.renderZone=function(t,e,a,n){var i=this,r=null;e.forEach(function(e){r||e.token!=t.defToken||(r=e)});var o=this.getModelGroups(t,r,a);i.meshCache={},i.textureCache={};var s=Object.keys(o);!function a(r){if(r>=s.length)return i.meshCache={},i.textureCache={},void n();var e=s[r],T=o[e],x=[];l.getMeshesForFilename(e,null,i.localReader,i.meshCache,i.textureCache,!1,function(e,t){e&&T.forEach(function(E,R){e.forEach(function(e,t){if(525!=e.materialFlags){var a={x:0,y:0,z:0};if(x[t])a.x=E.x-x[t].position.x,a.y=E.z-x[t].position.z,a.z=E.y-x[t].position.y;else{var r=e.geometry.clone().attributes;x[t]={readVerts:r.position.array,verts:new Float32Array(T.length*r.position.array.length),readIndices:r.index.array,indices:new Uint32Array(T.length*r.index.array.length),readUVs:r.uv.array,uvs:new Float32Array(T.length*r.uv.array.length),readNormals:r.normal.array,normals:new Float32Array(T.length*r.normal.array.length),material:e.material,position:{x:E.x,y:E.y,z:E.z}}}for(var n=x[t].readVerts,i=x[t].verts,o=n.length,s=0,l=R*o;s<o;s+=3,l+=3)i[l+0]=n[s+0]+a.x,i[l+1]=n[s+1]+a.y,i[l+2]=n[s+2]+a.z;var d=x[t].readIndices,f=x[t].indices,u=d.length,h=o*R/3;for(s=0,l=R*u;s<u;s++,l++)f[l]=d[s]+h;var m=x[t].readUVs,c=x[t].uvs,g=m.length;for(s=0,l=R*g;s<g;s++,l++)c[l]=m[s];var p=x[t].readNormals,v=x[t].normals,y=p.length;for(s=0,l=R*y;s<y;s++,l++)v[l]=p[s]}})}),x.forEach(function(e){var t=new THREE.BufferGeometry;t.addAttribute("position",new THREE.BufferAttribute(e.verts,3)),t.addAttribute("index",new THREE.BufferAttribute(e.indices,1)),t.addAttribute("normal",new THREE.BufferAttribute(e.normals,3)),t.addAttribute("uv",new THREE.BufferAttribute(e.uvs,2)),t.buffersNeedUpdate=!0,mesh=new THREE.Mesh(t,e.material),mesh.position.set(e.position.x,e.position.z,e.position.y),i.getOutput().meshes.push(mesh)}),a(r+1)})}(0)},this.getModelGroups=function(e,t,a){e.zPos;var r=a[0],n=a[1],i=48*e.vertRect[0]+r,o=(e.vertRect[2],-48*e.vertRect[1]-n);e.vertRect[3];if(0==e.encodeData.length)return{};for(var s=e.vertRect[0]-e.vertRect[2],l=(e.vertRect[1],e.vertRect[3],0),d={},f=this.getOutput(T3D.TerrainRenderer).terrainTiles,u=0;u<e.flags.length;u+=2){l+=e.flags[u];var h=e.flags[u+1];if(0!=h){var m=h>>4,c=t.layerDefArray[m-1];if(c){var g=l%s*48+i,p=48*Math.floor(l/s)+o,v=null,y=new THREE.Raycaster(new THREE.Vector3(g,1e5,p),new THREE.Vector3(0,-1,0));f.forEach(function(e){if(null===v){var t=y.intersectObject(e);0<t.length&&(v=1e5-t[0].distance)}});var E=c.modelArray[0],R=E.filename,T=(E.zOffsets,c.layerFlags,c.rotRangeX),x=c.rotRangeY,M=c.rotRangeZ,N=c.scaleRange,w=c.fadeRange;d[R]||(d[R]=[]),d[R].push({x:g,y:p,z:v,rotRangeX:T,rotRangeY:x,rotRangeZ:M,scaleRange:N,fadeRange:w})}}}return d}}((r.prototype=Object.create(n.prototype)).constructor=r).prototype.renderAsync=function(r){var n=this;n.getOutput().meshes=[];var e=this.mapFile.getChunk("zon2").data,t=this.mapFile.getChunk("parm").data,i=(this.mapFile.getChunk("trn").data,t.rect),o=e.zoneArray,s=e.zoneDefArray;lastPct=-1,function e(t){var a=Math.round(100*t/o.length);lastPct!=a&&(n.logger.log(T3D.Logger.TYPE_PROGRESS,"Loading 3D Models (Zone)",a),lastPct=a),t>=o.length?r():n.renderZone(o[t],s,i,e.bind(n,t+1))}(0)},t.exports=r},{"../util/RenderUtils":20,"./DataRenderer":5}],13:[function(e,t,a){t.exports=["version","uint8","magic","string:3","headerSize","uint32","unknown1","uint32","chunkSize","uint32","crc","uint32","unknown2","uint32","mftOffset",["[]","uint32",2],"mftSize","uint32","flags","uint32"]},{}],14:[function(e,t,a){t.exports=["magic","string:4","unknown1",["[]","uint32",2],"nbOfEntries","uint32","unknown2","uint32","unknown3","uint32"]},{}],15:[function(e,t,a){var r=["type","cstring:4","chunkDataSize","uint32","chunkVersion","uint16","chunkHeaderSize","uint16","offsetTableOffset","uint32"],o={ANIM:["MODL","Unknown"],GAME:["MODL","Unknown"],Main:["cntc","mMet"],SKEL:["MODL","Unknown"],TOOL:["AMAT","MODL"],main:["Unknown","Unknown","cmaC"],nvms:["Unknown","Unknown"]},n=function(e,t){this.ds=e,this.addr=t,this.data=null,this.headerLength=NaN,this.loadHead()};n.prototype.loadHead=function(){this.ds.seek(this.addr),this.header=this.ds.readStruct(r),this.headerLength=this.ds.position-this.addr},n.prototype.getDefinition=function(e){var t=0,a=o[this.header.type];if(a){t=-1;for(var r=0;r<a.length&&-1==t;r++){a[r]==e&&(t=r)}}var n=0;for(r=0;r<T3D.formats.length;r++){var i=T3D.formats[r];if(i.name==this.header.type){if(n==t&&i.versions[this.header.chunkVersion])return(new i.versions[this.header.chunkVersion]).__root;n++}}},n.prototype.loadData=function(e){var t=this.getDefinition(e);t?(this.ds.seek(this.addr+this.headerLength),this.data=this.ds.readStruct(t)):T3D.Logger.log(T3D.Logger.TYPE_WARNING,"Could not find a definition for chunk",this.header.type,"version",this.header.chunkVersion,"file name",e)},n.prototype.next=function(){try{return new n(this.ds,this.addr+8+this.header.chunkDataSize)}catch(e){}return null},t.exports=n},{}],16:[function(e,t,a){var r=e("./GW2Chunk"),n=["identifier","cstring:2","unknownField1","uint16","unknownField2","uint16","pkFileVersion","uint16","type","cstring:4"],i=function(e,t,a){this.ds=e,this.addr=t,this.data=null,this.headerLength=NaN,this.chunks=[],this.readHead(),a||this.readChunks()};i.prototype.readHead=function(){this.ds.seek(this.addr),this.header=this.ds.readStruct(n),this.headerLength=this.ds.position-this.addr},i.prototype.readChunks=function(){this.chunks=[];for(var e=new r(this.ds,this.headerLength+this.addr);null!=e&&e.header.type;)e.loadData(this.header.type),this.chunks.push(e),e=e.next()},i.prototype.getChunk=function(e){for(var t=0;t<this.chunks.length;t++)if(this.chunks[t].header.type.toLowerCase()==e.toLowerCase())return this.chunks[t];return null},i.prototype.getChunkStructs=function(){return{}},t.exports=i},{"./GW2Chunk":15}],17:[function(e,t,a){var r=t.exports={};r.getMaterial=function(e,t,r,n){if(t){var a,i=t.getChunk("dx9s"),o=t.getChunk("grmt"),s=[];if(e&&e.textures.length){for(var l=i.data.techniques[0].passes[0].effects[0],d=(i.data.shaders[l.pixelShader],[]),f=0;f<l.samplerIndex.length;f++){var u=l.samplerIndex[f],h=i.data.samplers[u];if(h){var m=h&&o.data.texTokens[h.textureIndex];m||(m="0-0");var c=null;if(e.textures.forEach(function(e,t){c||e.token.split("-")[0]!=m.split("-")[0]||(c=e)}),c)d.push(c);else if(h)d.push(e.textures[h.textureIndex]);else{if(!(0<e.textures.length))return;d.push(e.textures[0])}}}if(d.length<=0)return;d.forEach(function(e,t){if(e){var a=e&&e.filename;s[t]=p(a,r,n),s[t]&&(s[t].uvIdx=e.uvPSInputIndex)}})}if(s){var g=!1;if(e.textures.forEach(function(e){g||"1733499172"!=e.token.split("-")[0]||(g=e)}),!g||g.filename<=0)return;(a=new THREE.MeshLambertMaterial({side:THREE.DoubleSide,map:p(g.filename,r,n)})).textureFilename=g.filename,16460!=o.data.flags&&(a.alphaTest=.05)}else a=new THREE.MeshBasicMaterial({side:THREE.DoubleSide,color:16711680,shading:THREE.FlatShading});if(a.needsUpdate=!0,e){o=t.getChunk("grmt");1&e.materialFlags||16&e.materialFlags||e.materialFlags;[16460,16452,16448,8268,3392,2380,2368,332,324,320,76,68,64].indexOf(o.data.flags)<0&&T3D.Logger.log(T3D.Logger.TYPE_WARNING,"unknown GR flag",o.data.flags),8&o.data.flags||(a=new THREE.MeshBasicMaterial({side:THREE.DoubleSide,map:a.map})),16460!=o.data.flags&&(a.alphaTest=.05)}return a}};var p=r.getTexture=function(e,t,a){var r;return e&&a[e]?r=a[e]:e&&((r=n(t,e)).wrapT=THREE.RepeatWrapping,r.wrapS=THREE.RepeatWrapping,r.flipY=!1,a[e]=r),r},n=r.loadLocalTexture=function(e,t,a,r,i){void 0===r&&(r=Math.floor(16777215*Math.random()));var o=THREE.ImageUtils.generateDataTexture(1,1,new THREE.Color(r));return parseInt(t)<=0?i&&i():e.loadTextureFile(t,function(e,t,a,r){if(e){var n={data:new Uint8Array(e),width:a,height:r};o.format=THREE.RGBAFormat,o.image=n,o.needsUpdate=!0}else i&&i()}),o}},{}],18:[function(e,t,a){var r=t.exports={};r.f16=function(e){var t=(32768&e)>>15,a=(31744&e)>>10,r=1023&e;return 0==a?(t?-1:1)*Math.pow(2,-14)*(r/Math.pow(2,10)):31==a?r?NaN:1/0*(t?-1:1):(t?-1:1)*Math.pow(2,a-15)*(1+r/Math.pow(2,10))},r.popcount=function(e){var t=858993459,a=252645135;return e=((e=((e-=e>>1&1431655765)&t)+(e>>2&t))&a)+(e>>4&a),(e+=e>>8)+(e>>15)&63};var n=Math.pow(2,32);r.arr32To64=function(e){return n*e[1]+e[0]},r.sort_unique=function(e,t){for(var a=Array.prototype.sort.call(e,t),r={},n=[],i=0,o=a.length;i<o;++i)r.hasOwnProperty(a[i])||(n.push(a[i]),r[a[i]]=1);return n}},{}],19:[function(e,t,a){t.exports={getArrayReader:function(s,l){return function(e,t){var a=[];try{var r=e.readUint32(),n=e.readUint32();if(0==n)return a;var i=e.position-4+n,o=e.position;if(l&&l<r)throw"Array length "+r+" exceeded allowed maximum "+l;o=e.position;e.seek(i),a=e.readType(["[]",s,r],t),e.seek(o)}catch(e){console.warn("getArrayReader Failed loading array",e),console.warn("getArrayReader Failed loading array, structDef",s)}return a}},getRefArrayReader:function(f){return function(e,t){var a=[],r=e.readUint32(),n=e.position+e.readUint32();if(0==r)return a;var i=e.position;e.seek(n);var o=e.readInt32Array(r),s=i-4;e.seek(s),s+=e.readUint32();for(var l=0;l<o.length;l++)if(0!=o[l]){var d=s+4*l+o[l];e.seek(d);try{a.push(e.readStruct(f))}catch(e){a.push(null),console.warn("getRefArrayReader could not find refered data at offset",o[l],e)}}return e.seek(i),a}},getQWordReader:function(){return function(e,t){return e.readUint32()+"-"+e.readUint32()}},getStringReader:function(){return function(e,t){var a=e.position+e.readUint32(),r=e.position;e.seek(a);var n=e.readCString();return e.seek(r),n}},getString16Reader:function(o){return function(e,t){var a=e.position+e.readUint32()+(o||0),r=e.position;e.seek(a);for(var n,i="";e.position+2<e.byteLength&&0!=(n=e.readUint16());)i+=String.fromCharCode(n);return e.seek(r),i}},getPointerReader:function(o){return function(e,t){var a=e.readUint32();if(0==a)return{};var r=e.position-4+a,n=e.position;e.seek(r);var i=e.readStruct(o);return e.seek(n),i}},getFileNameReader:function(){return function(t,e){try{var a=t.position+t.readUint32(),r=t.position;t.seek(a);var n=t.readStruct(["m_lowPart","uint16","m_highPart","uint16","m_terminator","uint16"]),i=65280*(n.m_highPart-256)+(n.m_lowPart-256)+1;return i<0&&(i=0),t.seek(r),i}catch(e){return t.seek(r),-1}}}}},{}],20:[function(e,t,a){var g=e("../format/file/GW2File"),_=e("./MaterialUtils"),O=e("./MathUtils"),G={},z=1,W=2,B=4,Y=8,j=16,V=32,Z=64,q=128,X=65280,K=16711680,r=t.exports={},p=(r.renderRect=function(e,t,a,r){var n=e.x1-e.x2,i=e.y1-e.y2;r||(r=1);var o=(e.x1+e.x2)/2,s=(e.y1+e.y2)/2,l=t,d=new THREE.BoxGeometry(n,r,i);a=a||new THREE.MeshBasicMaterial({color:16711680,wireframe:!0});var f=new THREE.Mesh(d,a);return f.overdraw=!0,f.position.x=o,f.position.y=l,f.position.z=s,f},r.loadLocalTexture=function(e,t,a,r,n){return _.loadLocalTexture(e,t,a,r,n)},r.renderGeomChunk=function(C,e,S,P,H){var t=e.data.meshes,U=[],I=S.data.permutations[0].materials;return t.forEach(function(e){var t=e.geometry,a=t.verts.mesh.fvf,r=t.verts.vertexCount,n=t.verts.mesh.vertices,i=t.indices.indices,o=new THREE.BufferGeometry,s=new DataStream(n.buffer),l=n.length/r,d=new Float32Array(3*r),f=[],u=12*!!(a&z)+4*!!(a&W)+4*!!(a&B)+12*!!(a&Y)+4*!!(a&j)+12*!!(a&V)+12*!!(a&Z)+12*!!(a&q),h=(a&X)>>8,m=(a&K)>>16,c=!!h,g=!!m||!!h,p=c?h:m,v=O.popcount(p);if(v=Math.min(v,1),g)for(var y=0;y<v;y++)f[v-y]=new Float32Array(2*r);for(y=0;y<r;y++){s.seek(y*l);var E=s.readFloat32(),R=s.readFloat32(),T=s.readFloat32();if(d[3*y+0]=E,d[3*y+1]=-T,d[3*y+2]=-R,g)for(var x=0;x<v;x++){var M,N;s.seek(y*l+u+x*(c?8:4)),c?(M=s.readUint32(),N=s.readUint32()):(M=O.f16(s.readUint16()),N=O.f16(s.readUint16())),f[x][2*y+0]=M,f[x][2*y+1]=N}}var w=new Uint16Array(i.length);for(y=0;y<i.length;y+=3)w[y+0]=i[y+0],w[y+1]=i[y+1],w[y+2]=i[y+2];if(o.addAttribute("position",new THREE.BufferAttribute(d,3)),o.addAttribute("index",new THREE.BufferAttribute(w,1)),o.computeVertexNormals(),g){for(x=0;x<v;x++){var F="uv"+(0<x?x+1:"");o.addAttribute(F,new THREE.BufferAttribute(f[x],2)),o.attributes[F].needsUpdate=!0}o.uvsNeedUpdate=!0}o.buffersNeedUpdate=!0;var D=e.materialIndex,k=I[D],A=null;k&&G[k.filename]&&(A=G[k.filename]);var b=_.getMaterial(k,A,C,P);if(!b){if(!H)return;b=new THREE.MeshLambertMaterial({color:6009320,wireframe:!1,side:THREE.DoubleSide})}var L=new THREE.Mesh(o,b);k&&(L.materialFlags=k.materialFlags,L.materialFilename=k.filename),L.materialName=e.materialName,L.numLods=e.geometry.lods.length,L.lodOverride=S.data.lodOverride,L.flags=e.flags,L.numUV=v,U.push(L)}),U}),s=r.loadMeshFromModelFile=function(d,e,f,u,h,m){var c=[];f.loadFile(d,function(e){try{if(!e)throw"Could not find MFT entry for "+d;var t=new DataStream(e),a=new g(t,0),r=a.getChunk("modl"),n=a.getChunk("geom"),i=r.data.boundingSphere,o=i.center;i.radius+=Math.sqrt(o[0]*o[0]+Math.sqrt(o[1]*o[1]+o[2]*o[2]));var s=r.data.permutations[0].materials;!function r(n,i){if(n>=s.length)i();else{var o=s[n];G[o.filename]?r(n+1,i):f.loadFile(o.filename,function(e){if(e){var t=new DataStream(e),a=new g(t,0);G[o.filename]=a}r(n+1,i)})}}(0,function(){p(f,n,r,u,h).forEach(function(e){[0,8,9,520,2056,2057,2060,2061,2312,2316,2568,2569,2572,2573,2584,2824,2828,2840,4617,6664].indexOf(e.materialFlags),e.materialFlags,(h||2056&e.materialFlags)&&(4==e.flags||1==e.flags||e.flags,c.push(e))}),m(c,i)})}catch(e){console.warn("Failed rendering model "+d,e);var l=new THREE.Mesh(new THREE.BoxGeometry(200,2e3,200),new THREE.MeshNormalMaterial);l.flags=4,l.materialFlags=2056,l.lodOverride=[1e6,1e6],c.push(l),m(c)}})};r.getMeshesForFilename=function(a,e,t,r,n,i,o){r[a]?o(r[a].meshes,!0,r[a].boundingSphere):s(a,e,t,n,i,function(e,t){e&&(r[a]={meshes:e,boundingSphere:t}),o(e,!1,t)})},r.getFilesUsedByModel=function(a,e,r){var n=[a];e.loadFile(a,function(e){try{if(!e)throw"Could not find MFT entry for "+a;var t=new DataStream(e);new g(t,0).getChunk("modl").data.permutations[0].materials.forEach(function(e){var t=e.filename;n.push(t),e.textures.forEach(function(e){n.push(e.filename)})})}catch(e){console.warn("Could not export any data",e)}r(n)})}},{"../format/file/GW2File":16,"./MaterialUtils":17,"./MathUtils":18}]},{},[4])(4)});