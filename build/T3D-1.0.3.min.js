!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;"undefined"!=typeof window?t=window:"undefined"!=typeof global?t=global:"undefined"!=typeof self&&(t=self),t.T3D=e()}}(function(){return function e(t,a,r){function n(o,s){if(!a[o]){if(!t[o]){var l="function"==typeof require&&require;if(!s&&l)return l(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var d=a[o]={exports:{}};t[o][0].call(d.exports,function(e){var a=t[o][1][e];return n(a?a:e)},d,d.exports,e,t,a,r)}return a[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)n(r[o]);return n}({1:[function(e,t,a){var r=e("../format/file/GW2File.js"),n=e("../format/definition/ANDAT"),i=e("../format/definition/MFT"),o=e("../util/MathUtils.js"),s=e("../MapFileList"),l=function(e,t,a){this.fileListeners=[],this.dat=e,this.version=t,a?this.logger=a:this.logger=T3D.Logger};l.prototype.parseHeaderAsync=function(e){this.onFullyLoaded=e,this.loadFilePart(this.dat,0,40,this.readANDatHeader)},l.prototype.connectInflater=function(e,t){var a=this;this.NaClInflater=e,t.addEventListener("message",function(e){a.NaClListener.call(a,e)},!0)},l.prototype.NaClListener=function(e){if("string"==typeof e.data)return void this.logger.log(T3D.Logger.TYPE_WARNING,"NaCl threw an error",e.data);var t=e.data[0];this.fileListeners[t]&&(this.fileListeners[t].forEach(function(t){var a=e.data;t(a[1],a[2],a[3],a[4])}),this.fileListeners[t]=null)},l.prototype.readANDatHeader=function(e){this.fileHeader=e.readStruct(n),this.logger.log(T3D.Logger.TYPE_DEBUG,"Loaded Main .dat header",this.fileHeader),this.fileHeader.mftOffset=o.arr32To64(this.fileHeader.mftOffset),this.loadFilePart(this.dat,this.fileHeader.mftOffset,this.fileHeader.mftSize,this.readMFTHeader)},l.prototype.readMFTHeader=function(e){this.mft=e.readStruct(i);var t=(e.position,this.mft.nbOfEntries);this.mft.entryDict={offset_0:new Uint32Array(t),offset_1:new Uint32Array(t),offset:new Float64Array(t),size:new Uint32Array(t),compressed:new Uint16Array(t)},this.logger.log(T3D.Logger.TYPE_DEBUG,"reading MFT entries");for(var a=0;t-1>a;a++)this.mft.entryDict.offset_0[a]=e.readUint32(),this.mft.entryDict.offset_1[a]=e.readUint32(),this.mft.entryDict.size[a]=e.readUint32(),this.mft.entryDict.compressed[a]=e.readUint16(),this.mft.entryDict.offset[a]=o.arr32To64([this.mft.entryDict.offset_0[a],this.mft.entryDict.offset_1[a]]),e.seek(e.position+10);var r=o.arr32To64([this.mft.entryDict.offset_0[1],this.mft.entryDict.offset_1[1]]),n=this.mft.entryDict.size[1];this.loadFilePart(this.dat,r,n,this.readMFTIndexFile)},l.prototype.readMFTIndexFile=function(e,t){var a=t/8,r=new Uint32Array(a),n=new Uint32Array(a),i=new Uint32Array(a),o=new Uint32Array(a);this.mft.baseToMft=new Uint32Array(2e6),this.mft.fileToMft=new Uint32Array(2e6);for(var s=0;a>s;s++)r[s]=e.readUint32(),n[s]=e.readUint32();this.mft.id2index={ids:r,mftIndices:n};for(var s=0;a>s;s++)if(0!=r[s]||0!=n[s]){var l=n[s],d={fileId:o[l],baseId:i[l]};if(0==d.baseId?d.baseId=r[s]:0==d.fileId&&(d.fileId=r[s]),d.baseId>0&&d.fileId>0&&d.baseId>d.fileId){var f=d.baseId;d.baseId=d.fileId,d.fileId=f}this.mft.baseToMft[d.baseId]=l,this.mft.fileToMft[d.fileId]=l,o[l]=d.fileId,i[l]=d.baseId}this.mft.m_entryToId={baseId:i,fileId:o},this.logger.log(T3D.Logger.TYPE_DEBUG,"Finished indexing MFT ",this.mft),this.onFullyLoaded&&this.onFullyLoaded()},l.prototype.loadFileList=function(){var e=this.dat,t="fileList_"+this.version+"."+e.name+"_"+e.lastModified+"_"+e.size,a=localStorage.getItem(t);if(!a)return null;try{return JSON.parse(a)}catch(r){}return null},l.prototype.loadMapList=function(){var e=this.dat,t="mapList_"+this.version+"."+e.name+"_"+e.lastModified+"_"+e.size,a=localStorage.getItem(t);if(!a)return null;try{return JSON.parse(a)}catch(r){}return null},l.prototype.storeFileList=function(e,t){var a=JSON.stringify(t),r="fileList_"+this.version+"."+e.name+"_"+e.lastModified+"_"+e.size;localStorage.setItem(r,a)},l.prototype.storeMapList=function(e,t){var a="mapList_"+this.version+"."+e.name+"_"+e.lastModified+"_"+e.size;localStorage.setItem(a,JSON.stringify(t))},l.prototype.readFileListAsync=function(e){var t=this,a=this.mft.id2index.mftIndices,r=o.sort_unique(a,function(e,a){return t.mft.entryDict.offset[e]-t.mft.entryDict.offset[a]}),n=r.length;this.logger.log(T3D.Logger.TYPE_DEBUG,"Scanning ",n,"files");var i=8;this.listFiles(r,null,0,n,i,function(a){t.fileListeners=[],t.storeFileList(t.dat,a),e(a)})},l.prototype.readMapListAsync=function(e,t){var a=this,r=this.dat,n=[],i=8,l=(new Date).getTime();this.logger.log(T3D.Logger.TYPE_PROGRESS,"Finding maps (first visit only)","initializing"),e?n=this.mft.id2index.mftIndices:s.maps.forEach(function(e){e.maps.forEach(function(e){var t=e.fileName.split(".")[0],r=a.getFileIndex(t);n.push(r)})});var d=o.sort_unique(n,function(e,t){return a.mft.entryDict.offset[e]-a.mft.entryDict.offset[t]}),f=function(e){var n=(new Date).getTime()-l;a.logger.log(T3D.Logger.TYPE_DEBUG,"Time elapsed ",Math.round(.001*n)," seconds"),a.fileListeners=[];var i={maps:[]};e.mapc&&e.mapc.forEach(function(e){var t=a.mft.m_entryToId.baseId[e+1],r="",n="";s.maps.forEach(function(e){e.maps.forEach(function(a){0==r.length&&a.fileName.indexOf(t+".")>=0&&(r=a.name,n=e.name)})}),0==r.length&&(r="Unknown map "+t),0==n.length&&(n="Unknown maps");var o=null;i.maps.forEach(function(e){e.name==n&&(o=e)}),o||(o={name:n,maps:[]},i.maps.push(o)),o.maps.push({fileName:t,name:r})}),a.storeMapList(r,i),t(i)},u=d.length;this.logger.log(T3D.Logger.TYPE_DEBUG,"Scanning ",u," files for maps..."),this.listFiles(d,"mapc",0,u,i,f)},l.prototype.listFiles=function(e,t,a,n,i,o){for(var s=this,l=a+n,d=0,f=100/Math.min(n,e.length-a),u=0,h={},m=function(e,a,n){if(!e)return s.logger.log(T3D.Logger.TYPE_WARNING,"No infalted data for entry"),void c(a+i);var o,l=new DataStream(e),d=l.readCString(4);if("ATEX"==d||"ATEC"==d||"ATEP"==d||"ATET"==d||"ATEU"==d||"ATTX"==d)o="Texture";else if(0==d.indexOf("PF")){var f=new r(l,0,!0);o=f.header.type}else o=0==d.indexOf("MZ")?"Binary":"strs"==d?"String":"Unknown";t&&o!=t||(h[o]||(h[o]=[]),h[o].push(n)),c(a+i)},c=function(t){if(t%i==0){var r=Math.min(100,Math.floor((t-a)*f));d!=r&&(s.logger.log(T3D.Logger.TYPE_PROGRESS,"Find type",r),d=r)}if(t>=e.length||t>=l)return s.logger.log(T3D.Logger.TYPE_DEBUG,"Thread ",t%i+" done"),u++,void(u==i&&o(h));var n=e[t],g=s.mft.entryDict.compressed[n];if(!g)return void c(t+i);var p=n,v=s.mft.entryDict.offset[n],y=s.mft.entryDict.size[n];return 32>y?void c(t+i):void s.loadFilePart(s.dat,v,Math.min(y,2e3),function(e,a){s.inflate(e,a,p,function(e){m(e,t,n)},!1,32)})},g=0;i>g;g++)c(a+g)},l.prototype.getFileIndex=function(e){var t=-1;return e=parseInt(e),t=this.mft.m_entryToId.baseId.indexOf(e),-1!=t?t-1:(t=this.mft.m_entryToId.fileId.indexOf(e),-1!=t?t-1:t)},l.prototype.loadTextureFile=function(e,t){this.loadFile(e,t,!0)},l.prototype.loadFile=function(e,t,a,r){var n=this,i=this.getFileIndex(e),s=i;if(0>=s)return n.logger.log(T3D.Logger.TYPE_WARNING,"Could not find file with baseId ",e),void t(null);var l=o.arr32To64([this.mft.entryDict.offset_0[s],this.mft.entryDict.offset_1[s]]),d=this.mft.entryDict.size[s],f=this.mft.entryDict.compressed[s];if(!f)return n.logger.log(T3D.Logger.TYPE_WARNING,"File is NOT compressed, skipping"),void t(null);var u=i;this.loadFilePart(this.dat,l,d,function(e,i){r?t(e):n.inflate(e,i,u,t,a)})},l.prototype.inflate=function(e,t,a,r,n,i){var o=e.buffer;return i||(i=1),o.byteLength<12?(this.logger.log(T3D.Logger.TYPE_WARNING,"not inflating, length is too short ("+o.byteLength+")",a),void r(null)):123350==a||123409==a||123408==a?void r(null):this.fileListeners[a]?void this.fileListeners[a].push(r):(this.fileListeners[a]=[r],void this.NaClInflater.postMessage([a,o,n===!0,i]))},l.prototype.loadFilePart=function(e,t,a,r){var n=this,i=new FileReader;i.onerror=function(e){},i.onload=function(e){var t=e.target.result,i=new DataStream(t);i.endianness=DataStream.LITTLE_ENDIAN,r.call(n,i,a)};var o=t,s=o+a;i.readAsArrayBuffer(e.slice(o,s))},t.exports=l},{"../MapFileList":3,"../format/definition/ANDAT":13,"../format/definition/MFT":14,"../format/file/GW2File.js":16,"../util/MathUtils.js":18}],2:[function(e,t,a){var r={};r.TYPE_ERROR=4,r.TYPE_WARNING=3,r.TYPE_MESSAGE=2,r.TYPE_PROGRESS=1,r.TYPE_DEBUG=0,r.logFunctions=new Array(5),r.log=function(){if(0!=arguments.length){var e=r.argsToArr(arguments);1==e.length&&e.unshift(r.TYPE_MESSAGE);var t=Math.max(0,Math.min(r.logFunctions.length,e.shift())),a=r.logFunctions[t];a.apply(this,e)}},r.argsToArr=function(e){for(var t=new Array(e.length),a=0;a<t.length;++a)t[a]=e[a];return t},r.logFunctions[r.TYPE_ERROR]=function(){console.error.apply(console,arguments)},r.logFunctions[r.TYPE_WARNING]=function(){console.warn.apply(console,arguments)},r.logFunctions[r.TYPE_MESSAGE]=function(){console.log.apply(console,arguments)},r.logFunctions[r.TYPE_PROGRESS]=function(){var e=r.argsToArr(arguments);e.unshift("Progress: "),console.log.apply(console,e)},r.logFunctions[r.TYPE_DEBUG]=function(){var e=r.argsToArr(arguments);console.debug.apply(console,e)},t.exports=r},{}],3:[function(e,t,a){t.exports={maps:[{name:"Heart of Maguuma",maps:[{fileName:"1151420.data",name:"HoT BWE3 Raid"},{fileName:"969663.data",name:"Verdant Brink"},{fileName:"1262460.data",name:"HoT Personal story finale"}]},{name:"Maguuma Wastes",maps:[{fileName:"836211.data",name:"Dry top (Past)"},{fileName:"861770.data",name:"Dry top (Present)"},{fileName:"909361.data",name:"The Silverwastes v1"},{fileName:"996202.data",name:"The Silverwastes v2"}]},{name:"Other",maps:[{fileName:"184799.data",name:"Empty Plane v1"},{fileName:"197562.data",name:"Empty Plane v2"},{fileName:"875614.data",name:"Unknown Mists Platforms"},{fileName:"908730.data",name:"Glint's Lair"},{fileName:"969964.data",name:"Unknown Airship in tree"},{fileName:"wizard.data.zip",name:"Wizard's tower ZIP"},{fileName:"WizardsTowerSanctumCayLAKrytaMap.data",name:"Wizard's tower PARM"},{fileName:"vale.data.zip",name:"Fortunes Vale ZIP"},{fileName:"FortunesVale.data",name:"Fortunes Vale PARM"}]},{name:"PvP",maps:[{fileName:"871093.data",name:"Original Stronghold"},{fileName:"870987.data",name:"Champion's Dusk"},{fileName:"197249.data",name:"Heart of the Mists"},{fileName:"197402.data",name:"The Battle of Khylo"},{fileName:"197545.data",name:"Forest of Niflhel"},{fileName:"376916.data",name:"Legacy of the Foefire"},{fileName:"467374.data",name:"Raid on the Capricorn"},{fileName:"520609.data",name:"Temple of the Silent Storm"},{fileName:"677968.data",name:"Skyhammer"},{fileName:"791564.data",name:"Courtyard"},{fileName:"556199.data",name:"Spirit Watch"},{fileName:"506539.data",name:"Reaper's Rumble"},{fileName:"529718.data",name:"Snowball Mayhem"},{fileName:"595582.data",name:"Dragon Ball Arena"},{fileName:"617120.data",name:"Aspect Arena"}]},{name:"WvW",maps:[{fileName:"195806.data",name:"Eternal Battlegrounds"},{fileName:"641501.data",name:"Borderlands"},{fileName:"736241.data",name:"Edge of the Mists"}]},{name:"Dungeons",maps:[{fileName:"189364.data",name:"Ascalonian Catacombs"},{fileName:"275474.data",name:"Sorrow's Embrace"},{fileName:"276520.data",name:"Honor of the Waves"},{fileName:"284039.data",name:"Citadel of Flame"},{fileName:"287214.data",name:"Caudecus's Manor"},{fileName:"291284.data",name:"Twilight Arbor (Past)"},{fileName:"645968.data",name:"Twilight Arbor (Present)"},{fileName:"293606.data",name:"Crucible of Eternity"},{fileName:"473930.data",name:"The Ruined City of Arah"},{fileName:"473765.data",name:"Arah - Story"},{fileName:"580061.data",name:"Molten Facility"},{fileName:"595722.data",name:"Aetherblade Retreat"}]},{name:"The Mists (PvE)",maps:[{fileName:"519839.data",name:"Fractals of the Mists"},{fileName:"697450.data",name:"Thaumanova Reactor"},{fileName:"506592.data",name:"Ascent to Madness"},{fileName:"506670.data",name:"Mad King's Labyrinth (Past)"},{fileName:"662436.data",name:"Mad King's Labyrinth (Present)"},{fileName:"506739.data",name:"Mad King's Clock Tower"}]},{name:"Shiverpeak Mountains",maps:[{fileName:"187611.data",name:"Wayfarer Foothills"},{fileName:"568778.data",name:"Cragstead"},{fileName:"197122.data",name:"Hoelbrak"},{fileName:"186397.data",name:"Snowden Drifts"},{fileName:"275155.data",name:"Dredgehaunt Cliffs"},{fileName:"276252.data",name:"Frostgorge Sound"},{fileName:"277587.data",name:"Lornar's Pass"},{fileName:"278717.data",name:"Timberline Falls (Past)"},{fileName:"846866.data",name:"Timberline Falls (Present)"}]},{name:"Far Shiverpeaks",maps:[{fileName:"295282.data",name:"Eye of the North"}]},{name:"Ascalon",maps:[{fileName:"188591.data",name:"Plains of Ashford"},{fileName:"190490.data",name:"Diessa Plateau"},{fileName:"196585.data",name:"Black Citadel"},{fileName:"280025.data",name:"Blazeridge Steppes"},{fileName:"281313.data",name:"Fireheart Rise"},{fileName:"282668.data",name:"Iron Marches"},{fileName:"283574.data",name:"Fields of Ruin"}]},{name:"Kryta",maps:[{fileName:"191000.data",name:"Lion's Arch"},{fileName:"191265.data",name:"Divinity's Reach"},{fileName:"705746.data",name:"Divinity's Reach"},{fileName:"193081.data",name:"North of Divinity's Reach"},{fileName:"192711.data",name:"Queensdale"},{fileName:"194288.data",name:"Kessex Hills v1"},{fileName:"672138.data",name:"Kessex Hills v2"},{fileName:"861815.data",name:"Kessex Hills v3"},{fileName:"286945.data",name:"Bloodtide Coast"},{fileName:"287870.data",name:"Harathi Hinterlands"},{fileName:"289176.data",name:"Gendarran Fields"},{fileName:"295005.data",name:"Chantry of Secrets"},{fileName:"294938.data",name:"Claw Island"},{fileName:"520479.data",name:"Southsun Cove"},{fileName:"622681.data",name:"The Crown Pavilion"},{fileName:"679089.data",name:"Tower of Nightmares"}]},{name:"Maguuma Jungle",maps:[{fileName:"195149.data",name:"Caledon Forest"},{fileName:"195493.data",name:"Metrica Province"},{fileName:"922320.data",name:"Metrica Province Instance"},{fileName:"198076.data",name:"The Grove"},{fileName:"198272.data",name:"Rata Sum"},{fileName:"291064.data",name:"Mount Maelstrom"},{fileName:"292254.data",name:"Sparkfly Fen"},{fileName:"293307.data",name:"Brisban Wildlands"},{fileName:"636133.data",name:"SAB Hub"},{fileName:"635555.data",name:"SAB World 1"},{fileName:"635960.data",name:"SAB World 2"},{fileName:"606255.data",name:"Zephyr Sanctum"},{fileName:"605983.data",name:"Sanctum Sprint"},{fileName:"606030.data",name:"Basket Brawl"}]},{name:"Ruins of Orr",maps:[{fileName:"284829.data",name:"Straits of Devastation"},{fileName:"285089.data",name:"Malchor's Leap"},{fileName:"285634.data",name:"Cursed Shore"},{fileName:"295179.data",name:"Cathedral of Hidden Depths"},{fileName:"295962.data",name:"A Light in the Darkness"}]},{name:"Enchanted Snow Globe",maps:[{fileName:"529896.data",name:"Tixx's Infinirarium"},{fileName:"529945.data",name:"Winter Wonderland"}]},{name:"Historical Maps",maps:[{fileName:"814803.data",name:"Lion's Arch"},{fileName:"579383.data",name:"Skyhammer"},{fileName:"569756.data",name:"SAB"},{fileName:"122695.data",name:"Empty Plane"},{fileName:"127888.data",name:"Diessa Plateau"},{fileName:"128151.data",name:"Divinity's Reach"},{fileName:"129524.data",name:"Queensdale"},{fileName:"129834.data",name:"North of Divinity's Reach"},{fileName:"130970.data",name:"Kessex Hills"},{fileName:"131235.data",name:"Eternal Battlegrounds"},{fileName:"131574.data",name:"Borderlands"},{fileName:"131944.data",name:"Black Citadel"},{fileName:"132434.data",name:"Hoelbrak"},{fileName:"132570.data",name:"Heart of the Mists"},{fileName:"132710.data",name:"The Battle of Khylo"},{fileName:"132837.data",name:"Forest of Niflhel"},{fileName:"132853.data",name:"Empty Box"},{fileName:"124093.data",name:"Snowden Drifts"},{fileName:"125199.data",name:"Wayfarer Foothills"},{fileName:"126118.data",name:"Plains of Ashford"},{fileName:"126840.data",name:"Ascalonian Catacombs"}]}]}},{}],4:[function(e,t,a){function r(){}function n(){var e=0,t=navigator.userAgent.toLowerCase().indexOf("chrome")>-1;return t||(r.Logger.log(r.Logger.TYPE_ERROR,"T3D inflation requires Google Chrome."),e++),"undefined"==typeof DataStream&&(r.Logger.log(r.Logger.TYPE_ERROR,"T3D core functionality requires DataStream library."),e++),"undefined"==typeof THREE&&(r.Logger.log(r.Logger.TYPE_WARNING,"T3D mesh generation requires three.js library."),e++),1>e&&r.Logger.log(r.Logger.TYPE_MESSAGE,"Tyria 3D API v"+r.version+" initialized."),e}LocalReader=e("./LocalReader/LocalReader.js"),t.exports=r;var i="1.0.3",o={inflaterURL:"modules/nacl/t3dgwtools.nmf"};r.version=i,r.GW2File=e("./format/file/GW2File"),r.GW2Chunk=e("./format/file/GW2Chunk"),r.DataRenderer=e("./dataRenderer/DataRenderer"),r.EnvironmentRenderer=e("./dataRenderer/EnvironmentRenderer"),r.HavokRenderer=e("./dataRenderer/HavokRenderer"),r.PropertiesRenderer=e("./dataRenderer/PropertiesRenderer"),r.ModelRenderer=e("./dataRenderer/ModelRenderer"),r.TerrainRenderer=e("./dataRenderer/TerrainRenderer"),r.ZoneRenderer=e("./dataRenderer/ZoneRenderer"),r.StringRenderer=e("./dataRenderer/StringRenderer"),r.Logger=e("./Logger"),r.MapFileList=e("./MapFileList"),r.MaterialUtils=e("./util/MaterialUtils.js"),r.MathUtils=e("./util/MathUtils.js"),r.ParserUtils=e("./util/ParserUtils.js"),r.RenderUtils=e("./util/RenderUtils.js"),r.getLocalReader=function(e,t,a,r){var n=document.createElement("div");n.setAttribute("id","pNaClListener");var s=document.createElement("embed");s.setAttribute("type","application/x-pnacl"),s.style.position="absolute",s.style.height=0,s.style.width=0,s.setAttribute("src",a?a:o.inflaterURL),n.appendChild(s),document.body.appendChild(n);var l=new LocalReader(e,i,r);return l.connectInflater(s,n),l.parseHeaderAsync(t),l},r.getFileListAsync=function(e,t){var a=e.loadFileList();a?t(a):e.readFileListAsync(t)},r.getMapListAsync=function(e,t,a){if(a)return void e.readMapListAsync(!0,t);var r=e.loadMapList();r?t(r):e.readMapListAsync(!1,t)},r.renderMapContentsAsync=function(e,t,a,n,i){var o={};if(parseInt(t))e.loadFile(t,function(t){var i=new DataStream(t,0,DataStream.LITTLE_ENDIAN),s=new r.GW2File(i,0),l=function(t){t<a.length?r.runRenderer(a[t].renderClass,e,Object.assign(a[t].settings,{mapFile:s}),o,l.bind(this,t+1)):n(o)};l(0)});else{var s=i?i:r.Logger;s.log(r.Logger.TYPE_ERROR,"Map id must be an integer!, was:",t)}},r.runRenderer=function(e,t,a,r,n){var i=new e(t,a,r);i.renderAsync(n)},r.getContextValue=function(e,t,a,r){var n=e[t.name];return n&&n[a]?n[a]:r},r.hasWebGL=function(e){if(window.WebGLRenderingContext){for(var t=document.createElement("canvas"),a=["webgl","experimental-webgl","moz-webgl","webkit-3d"],r=!1,n=0;4>n;n++)try{if(r=t.getContext(a[n]),r&&"function"==typeof r.getParameter)return e?{name:a[n],gl:r}:!0}catch(i){}return!1}return!1},n()},{"./LocalReader/LocalReader.js":1,"./Logger":2,"./MapFileList":3,"./dataRenderer/DataRenderer":5,"./dataRenderer/EnvironmentRenderer":6,"./dataRenderer/HavokRenderer":7,"./dataRenderer/ModelRenderer":8,"./dataRenderer/PropertiesRenderer":9,"./dataRenderer/StringRenderer":10,"./dataRenderer/TerrainRenderer":11,"./dataRenderer/ZoneRenderer":12,"./format/file/GW2Chunk":15,"./format/file/GW2File":16,"./util/MaterialUtils.js":17,"./util/MathUtils.js":18,"./util/ParserUtils.js":19,"./util/RenderUtils.js":20}],5:[function(e,t,a){var r=e("../format/file/GW2File"),n=t.exports=function(e,t,a,r){this.localReader=e,this.settings=t,t||(t={}),this.context=a,this.context[this.constructor.name]={},r?this.logger=r:this.logger=T3D.Logger};n.prototype.getOutput=function(e){return this.context[e?e.name:this.constructor.name]},n.prototype.renderAsync=function(e){var t=this;this.localReader.loadFile(this.settings.id,function(a){t.getOutput().fileId=t.settings.id,t.getOutput().rawData=a;for(var n=new Uint8Array(a),i=[],o=65535,s=Math.min(n.length,1e4),l=0;s>l*o;l++)i.push(String.fromCharCode.apply(null,n.subarray(l*o,(l+1)*o)));s<n.length&&i.push("T3D Ignored the last "+(n.length-s)+" bytes when generating this raw output"),t.getOutput().rawString=i.join();var d=new DataStream(a),f=d.readCString(4);"ATEX"==f||"ATEC"==f||"ATEP"==f||"ATET"==f||"ATEU"==f||"ATTX"==f?t.localReader.loadTextureFile(t.settings.id,function(a,r,n,i){var o={data:new Uint8Array(a),width:n,height:i};t.getOutput().image=o,e()}):0==f.indexOf("PF")?(t.getOutput().file=new r(d,0),e()):(t.getOutput().file=null,e())})}},{"../format/file/GW2File":16}],6:[function(e,t,a){function r(e,t,a,r){i.call(this,e,t,a,r),this.mapFile=this.settings.mapFile,this.getMat=function(e){return new THREE.MeshBasicMaterial({map:e,side:THREE.BackSide,fog:!1,depthWrite:!1})},this.loadTextureWithFallback=function(t,a,r,i,o){function s(e){t.forEach(function(t){a[t]=e})}function l(){var e=f.getMat(THREE.ImageUtils.loadTexture(i));s(e)}function d(){setTimeout(l,1)}var f=this,u=f.getMat(n.loadLocalTexture(e,r,null,o,d));s(u)},this.getHazeColor=function(e){var t=e&&e.dataGlobal.haze;return!t||t.length<=0?[190,160,60]:t[0].farColor},this.parseLights=function(e){var t=this;t.getOutput().lights=[];var a,r=e?e.dataGlobal.lighting:[{lights:[],backlightIntensity:1,backlightColor:[255,255,255]}],n=!1;r.forEach(function(e,r){if(!n){var i=0;if(e.lights.forEach(function(e,a){n=!0;var r=new THREE.Color(e.color[2]/255,e.color[1]/255,e.color[0]/255),o=new THREE.DirectionalLight(r.getHex(),e.intensity);o.position.set(-e.direction[0],e.direction[2],e.direction[1]).normalize(),i+=e.intensity,t.getOutput().lights.push(o)}),!e.lights||0==e.lights.length){var o=[[0,1,0,.3],[1,2,1,.3],[-1,-2,-1,.3]];o.forEach(function(e){var a=new THREE.Color(1,1,1),r=e[3],n=new THREE.DirectionalLight(a.getHex(),r);n.position.set(e[0],e[1],e[2]).normalize(),i+=r,t.getOutput().lights.push(n)})}e.backlightIntensity=e.backlightIntensity;var s=new THREE.Color(e.backlightIntensity*(255-e.backlightColor[2])/255,e.backlightIntensity*(255-e.backlightColor[1])/255,e.backlightIntensity*(255-e.backlightColor[0])/255);a=new THREE.AmbientLight(s)}});var i=0;a&&(i=a.color.r+a.color.g+a.color.b,this.getOutput().lights.push(a)),this.getOutput().hasLight=n||i>0},this.parseSkybox=function(e,t,a){this.getOutput().skyElements=[];var r=this.environmentChunkData&&this.environmentChunkData.dataGlobal.skyModeTex[0];r||(r={texPathNE:1930687,texPathSW:193069,texPathT:193071});var n=t.rect,i=Math.abs(n.x1-n.x2),o=Math.abs(n.y1-n.y2),s=(Math.max(i,o),[]);this.loadTextureWithFallback([1,4],s,r.texPathNE+1,"img/193068.png",a),this.loadTextureWithFallback([0,5],s,r.texPathSW+1,"img/193070.png",a),this.loadTextureWithFallback([2],s,r.texPathT+1,"img/193072.png",a),s[3]=new THREE.MeshBasicMaterial({visible:!1});var l=1024,d=new THREE.BoxGeometry(l,l/2,l);d.faceVertexUvs[0].forEach(function(e,t){var a=Math.floor(t/2);0==a||1==a?e.forEach(function(e){e.x=1-e.x,e.y/=2,e.y+=.5}):5==a||4==a?e.forEach(function(e){e.y/=-2,e.y+=.5}):e.forEach(function(e){e.x=1-e.x})}),d.uvsNeedUpdate=!0;var f=new THREE.MeshFaceMaterial(s),u=new THREE.Mesh(d,f);u.translateY(l/4),this.getOutput().skyElements.push(u)}}var n=e("../util/RenderUtils"),i=e("./DataRenderer");r.prototype=Object.create(i.prototype),r.prototype.constructor=r,r.prototype.renderAsync=function(e){var t=this.mapFile.getChunk("env").data,a=this.mapFile.getChunk("parm").data,r=this.getHazeColor(t),n=256*r[2]*256+256*r[1]+r[0];this.getOutput().hazeColor=r,this.parseLights(t),this.parseSkybox(t,a,n),e()},t.exports=r},{"../util/RenderUtils":20,"./DataRenderer":5}],7:[function(e,t,a){function r(e,t,a,r){n.call(this,e,t,a,r),this.mapFile=this.settings.mapFile,this.lastP=-1,this.seed=1,this.meshes=[],this.renderModels=function(e,t,a){var r;r=this.settings&&this.settings.visible?new THREE.MeshNormalMaterial({side:THREE.DoubleSide}):new THREE.MeshBasicMaterial({visible:!1}),this.parseAllModels(e,r,t,200,0,a)},this.getCollisionsForAnimation=function(e,t){for(var a=[],r=0;r<e.collisionIndices.length;r++){var n=e.collisionIndices[r],i=t[n];i.index=n,a.push(i)}return a},this.parseAllModels=function(e,t,a,r,n,i){for(var o=n;n+r>o&&o<e.length;o++){var s=Math.round(100*o/e.length);s!=this.lastP&&(this.logger.log(T3D.Logger.TYPE_PROGRESS,"Loading Collision Models ("+a+")",s),this.lastP=s);for(var l=this.animationFromGeomIndex(e[o].geometryIndex,this.geometries,this.animations),d=this.getCollisionsForAnimation(l,this.havokChunkData.collisions),f=0;f<d.length;f++){var u=d[f];this.renderMesh(u,e[o],t)}}o<e.length?window.setTimeout(this.parseAllModels.bind(this,e,t,a,r,n+r,i),10):i()},this.animationFromGeomIndex=function(e,t,a){var r=t[e].animations.length;return a[t[e].animations[r-1]]},this.renderMesh=function(e,t,a){var r=t.translate,n=t.rotate,i=32*t.scale,o=this.parseHavokMesh(e,a);o.position.set(r[0],-r[2],-r[1]),i&&o.scale.set(i,i,i),n&&(o.rotation.order="ZXY",o.rotation.set(n[0],-n[2],-n[1])),this.getOutput().meshes.push(o)},this.seedRandom=function(){var e=1e4*Math.sin(this.seed++);return e-Math.floor(e)},this.parseHavokMesh=function(e,t){var a=e.index;if(this.meshes[a])return this.meshes[a].clone();for(var r=new THREE.Geometry,n=0;n<e.vertices.length;n++){var i=e.vertices[n];r.vertices.push(new THREE.Vector3(i[0],i[2],-i[1]))}for(var n=0;n<e.indices.length;n+=3){var o=e.indices[n],s=e.indices[n+1],l=e.indices[n+2];o<=e.vertices.length&&s<=e.vertices.length&&l<=e.vertices.length?r.faces.push(new THREE.Face3(o,s,l)):this.logger.log(T3D.Logger.TYPE_ERROR,"Errorus index in havok model geometry.")}return r.computeFaceNormals(),this.meshes[a]=new THREE.Mesh(r,t),this.meshes[a]}}var n=e("./DataRenderer");r.prototype=Object.create(n.prototype),r.prototype.constructor=r,r.prototype.renderAsync=function(e){var t=this;this.havokChunkData=this.mapFile.getChunk("havk").data,this.getOutput().boundingBox=this.havokChunkData.boundsMax,this.meshes=[],this.getOutput().meshes=[];var a=this.havokChunkData.propModels,r=this.havokChunkData.zoneModels,n=this.havokChunkData.obsModels;n.forEach(function(e){e.scale=1}),this.geometries=this.havokChunkData.geometries,this.animations=this.havokChunkData.animations;var i=function(){t.renderModels(r,"zone",o)},o=function(){t.renderModels(n,"obs",e)};t.renderModels(a,"prop",i)},t.exports=r},{"./DataRenderer":5}],8:[function(e,t,a){function r(e,t,a,r){i.call(this,e,t,a,r)}var n=e("../util/RenderUtils"),i=e("./DataRenderer");r.prototype=Object.create(i.prototype),r.prototype.constructor=r,r.prototype.renderAsync=function(e){var t=this,a=this.settings.id,r=!0,i={},o={};t.getOutput().meshes=[],n.getMeshesForFilename(a,65280,t.localReader,i,o,r,function(a,r,n){a&&a.forEach(function(e){e.boundingSphere=n,t.getOutput().meshes.push(e)}),i={},e()})},t.exports=r},{"../util/RenderUtils":20,"./DataRenderer":5}],9:[function(e,t,a){function r(e,t,a,r){i.call(this,e,t,a,r),this.mapFile=this.settings.mapFile}var n=e("../util/RenderUtils"),i=e("./DataRenderer");r.prototype=Object.create(i.prototype),r.prototype.constructor=r,r.prototype.renderAsync=function(e){var t=this;t.getOutput().meshes=[];var a=this.mapFile.getChunk("prp2").data;if(!a)return void renderCallback();var r=a.propArray,i=a.propAnimArray,o=a.propInstanceArray,s=a.propMetaArray;r=r.concat(i).concat(o).concat(s),t.meshCache={},t.textureCache={};var l=-1,d=function(a){if(a>=r.length)return t.meshCache={},t.textureCache={},void e();var i=Math.round(1e3*a/r.length);if(i/=10,l!=i){var o=i+(i.toString().indexOf(".")<0?".0":"");t.logger.log(T3D.Logger.TYPE_PROGRESS,"Loading 3D Models (Props)",o),l=i}var s=r[a],f=function(e,t,a,r,n){var i=0!=r.lod2?r.lod2:e.lodOverride[1],o=e.flags;if(0==o&&(i=0),n&&(e=new THREE.Mesh(e.geometry,e.material)),e.updateMatrix(),e.matrixAutoUpdate=!1,t[i])t[i].add(e);else{var s=new THREE.Group;s.updateMatrix(),s.matrixAutoUpdate=!1,s.add(e),t[i]=s,a.addLevel(s,i)}return i},u=function(e,a,r){var n={},i=new THREE.LOD,o=0;e.forEach(function(e){o=Math.max(o,f(e,n,i,s,a))}),s.rotation&&(i.rotation.order="ZXY",i.rotation.set(s.rotation[0],-s.rotation[2],-s.rotation[1])),i.scale.set(s.scale,s.scale,s.scale),i.position.set(s.position[0],-s.position[2],-s.position[1]),i.boundingSphereRadius=(r&&r.radius?r.radius:1)*s.scale,i.updateMatrix(),i.matrixAutoUpdate=!1,t.getOutput().meshes.push(i),s.transforms&&s.transforms.forEach(function(a){var n={},i=new THREE.LOD,o=0;e.forEach(function(e){o=Math.max(o,f(e,n,i,s,!0))}),a.rotation&&(i.rotation.order="ZXY",i.rotation.set(a.rotation[0],-a.rotation[2],-a.rotation[1])),i.scale.set(a.scale,a.scale,a.scale),i.position.set(a.position[0],-a.position[2],-a.position[1]),i.updateMatrix(),i.matrixAutoUpdate=!1,i.boundingSphereRadius=(r&&r.radius?r.radius:1)*s.scale,t.getOutput().meshes.push(i)})},h=!1;n.getMeshesForFilename(s.filename,s.color,t.localReader,t.meshCache,t.textureCache,h,function(e,t,r){e&&u(e,t,r),d(a+1)})};d(0)},r.prototype.getFileIdsAsync=function(e){var t=[],a=this.mapFile.getChunk("prp2").data,r=a.propArray,i=a.propAnimArray,o=a.propInstanceArray,s=a.propMetaArray;r=r.concat(i).concat(o).concat(s);var l=function(a){if(a>=r.length)return void e(t);a%100==0&&this.logger.log(T3D.Logger.TYPE_MESSAGE,"getting ids for entry",a,"of",r.length);var i=r[a];n.getFilesUsedByModel(i.filename,localReader,function(e){t=t.concat(e),l(a+1)})};l(0)},t.exports=r},{"../util/RenderUtils":20,"./DataRenderer":5}],10:[function(e,t,a){function r(e,t,a,r){n.call(this,e,t,a,r)}var n=(e("../util/RenderUtils"),e("./DataRenderer"));r.prototype=Object.create(n.prototype),r.prototype.constructor=r,r.prototype.renderAsync=function(e){var t=this;this.settings.id;this.getOutput().strings=[],this.localReader.loadFile(this.settings.id,function(a){var r=new DataStream(a),n=r.byteLength-2;r.seek(4);for(var i=["size","uint16","decryptionOffset","uint16","bitsPerSymbol","uint16"],o=0;n-r.position>6;){var s=r.readStruct(i);if(s.size-=6,s.size>0){var l=0!=s.decryptionOffset||16!=s.bitsPerSymbol;if(!l){var d=r.readUCS2String(s.size/2);t.getOutput().strings.push({value:d,recid:o})}}o++}r.seek(r.byteLength-2),t.getOutput().language=r.readUint16(),e()})},t.exports=r},{"../util/RenderUtils":20,"./DataRenderer":5}],11:[function(e,t,a){function r(e,t,a,r,s){i.call(this,e,t,a,r,s),this.mapFile=this.settings.mapFile,this.drawWater=function(e){var t=t||new THREE.MeshBasicMaterial({color:6009320,wireframe:!1,opacity:.35});return t.transparent=!0,n.renderRect(e,0,t)},this.parseNumChunks=function(e){e.numChunksD_1=Math.sqrt(e.dims[0]*e.chunkArray.length/e.dims[1]),e.numChunksD_2=e.chunkArray.length/e.numChunksD_1},this.loadPagedImageCallback=function(e,t){var a=this;a.getOutput().terrainTiles=[];var r=new DataStream(t),i=new o(r,0),s=i.getChunk("pgtb"),l=s&&s.data;this.mapRect=null;var d=this.mapFile.getChunk("trn").data,f=this.mapFile.getChunk("parm").data,u=this.settings.anisotropy?this.settings.anisotropy:1,h=35;this.parseNumChunks(d);var m=d.numChunksD_1,c=d.numChunksD_2,g=d.materials.materials,p=d.materials.texFileArray,v=f.rect[2]-f.rect[0],y=f.rect[3]-f.rect[1],E=v/d.numChunksD_1*1,R=y/d.numChunksD_2*1,T=0,x=[],M=new THREE.MeshLambertMaterial({side:THREE.DoubleSide,color:6710886,shading:THREE.FlatShading}),N={};if(l){var w=l.strippedPages;w.forEach(function(e){if(e.layer<=1){var t=e.filename,r=(e.solidColor,e.coord),i=r[0]+","+r[1];if(1==e.layer&&(i+="-2"),!N[i]){var o=n.loadLocalTexture(a.localReader,t);o&&(o.anisotropy=u,o.wrapT=o.wrapS=THREE.RepeatWrapping),N[i]=o}}})}var F=function(e,t){for(var r=t*m+e,i=Math.floor(e/4),o=Math.floor(t/4),s=g[r].loResMaterial.texIndexArray,l=(g[r].loResMaterial.materialFile,d.chunkArray[r],p[s[0]],M),c=e%4/4,v=.75-t%4/4,y=[],w=0;w<s.length/2;w++){var F=p[s[w]].filename;if(y.push(F),!N[F]){var D=n.loadLocalTexture(a.localReader,F);D&&(D.anisotropy=u,D.wrapT=D.wrapS=THREE.RepeatWrapping),N[F]=D}}var k=i+","+o,A=i+","+o+"-2",b={color:{r:1,g:1,b:1},near:0,far:0},L=a.getOutput(T3D.EnvironmentRenderer);L.hazeColor&&(b.color.r=L.hazeColor[2]/255,b.color.g=L.hazeColor[1]/255,b.color.b=L.hazeColor[0]/255);var C=THREE.UniformsUtils.merge([THREE.UniformsLib.lights]);C.fogColor={type:"v3",value:new THREE.Vector3(b.color.r,b.color.g,b.color.b)},C.fogNear={type:"f",
value:b.near},C.fogFar={type:"f",value:b.far},C.uvScale={type:"v2",value:new THREE.Vector2(8,8)},C.offset={type:"v2",value:new THREE.Vector2(c,v)},C.texturePicker={type:"t",value:N[k]},C.texturePicker2={type:"t",value:N[A]},C.texture1={type:"t",value:N[y[0]]},C.texture2={type:"t",value:N[y[1]]},C.texture3={type:"t",value:N[y[2]]},C.texture4={type:"t",value:N[y[3]]},l=new THREE.ShaderMaterial({uniforms:C,vertexShader:"varying vec2 vUv;\r\nvarying vec3 vecNormal;\r\nvoid main()\r\n{\r\nvUv =  uv;\r\nvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\r\nvecNormal = (modelMatrix * vec4(normal, 0.0)).xyz;\r\ngl_Position = projectionMatrix * mvPosition;\r\n}",fragmentShader:"\r\nuniform vec3 fogColor;\r\nuniform float fogNear;\r\nuniform float fogFar;\r\nuniform vec2 uvScale;\r\nuniform vec2 offset;\r\nuniform sampler2D texturePicker;\r\nuniform sampler2D texturePicker2;\r\nuniform sampler2D texture1;\r\nuniform sampler2D texture2;\r\nuniform sampler2D texture3;\r\nuniform sampler2D texture4;\r\nuniform vec3 ambientLightColor;\r\n#if MAX_DIR_LIGHTS > 0\r\nuniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];\r\nuniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];\r\n#endif\r\nvarying vec2 vUv;\r\nvarying vec3 vecNormal;\r\nvec3 blend(\r\nvec4 texture1, float a1,\r\nvec4 texture2, float a2,\r\nvec4 texture3, float a3,\r\nvec4 texture4, float a4)\r\n{\r\nfloat depth = 2.0;\r\nfloat alphaMult = 1.0;\r\nfloat alphaAdd  = 0.0;\r\na1 *= 4.0;\r\na2 *= 4.0;\r\na3 *= 4.0;\r\na4 *= 4.0;\r\na1 =  a1+(1.5+texture1.a);\r\na2 =  a2+(1.5+texture2.a);\r\na3 =  a3+(1.5+texture3.a);\r\na4 =  a4+(1.5+texture4.a);\r\nfloat ma = max(a1,a2);\r\nma = max(ma,a3);\r\nma = max(ma,a4);\r\nma -= depth;\r\nfloat b1 = max(a1 - ma, 0.0);\r\nfloat b2 = max(a2 - ma, 0.0);\r\nfloat b3 = max(a3 - ma, 0.0);\r\nfloat b4 = max(a4 - ma, 0.0);\r\nreturn (\r\ntexture1.rgb * b1 +\r\ntexture2.rgb * b2 +\r\ntexture3.rgb * b3 +\r\ntexture4.rgb * b4 \r\n) / (b1 + b2 + b3 +b4);\r\n}\r\nvoid main( void ) {\r\nvec2 position = vUv*uvScale;\r\nfloat edge = 1.0/1024.0;\r\nvec2 compPos = edge +  (vUv*0.25 + offset)*(1.0-edge*2.0);\r\nvec4 tp1 = texture2D( texturePicker, compPos);\r\nvec4 tp2 = texture2D( texturePicker2, compPos);\r\nvec4 composite = tp1;\r\nvec4 t1 = texture2D( texture1, position );\r\nvec4 t2 = texture2D( texture2, position );\r\nvec4 t3 = texture2D( texture3, position );\r\nvec4 t4 = texture2D( texture4, position );\r\nvec3 color = blend(\r\nt1, tp1.a,\r\nt2, tp1.b,\r\nt3, tp1.g,\r\nt4, tp1.r\r\n);\r\ncolor *= 0.5+tp2.r;\r\ngl_FragColor = vec4(color,1.0);\r\nvec4 addedLights = vec4(ambientLightColor, 1.0);\r\n#if MAX_DIR_LIGHTS > 0\r\nfor(int l = 0; l < MAX_DIR_LIGHTS; l++) {\r\naddedLights.rgb += clamp(\r\ndot(-directionalLightDirection[l], vecNormal),\r\n0.0,\r\n1.0\r\n)\r\n* directionalLightColor[l];\r\n}\r\n#endif\r\ngl_FragColor *= addedLights;\r\nfloat depth = gl_FragCoord.z / gl_FragCoord.w;\r\nfloat fogFactor = smoothstep( fogNear, fogFar, depth );\r\ngl_FragColor.xyz = mix( gl_FragColor.xyz, fogColor.xyz, fogFactor );\r\n}",lights:!0}),x.push(l);for(var S=new THREE.PlaneBufferGeometry(E,R,h-3,h-3),P=0,U=0;h>U;U++)for(var H=0;h>H;H++)0!=H&&H!=h-1&&0!=U&&U!=h-1&&(S.attributes.position.array[3*P+2]=d.heightMapArray[T],P++),T++;var I=(new THREE.Matrix4).identity();I.elements[5]=-1,S.applyMatrix(I),S.computeFaceNormals();var _;_=new THREE.Mesh(S,M),_=l.length?THREE.SceneUtils.createMultiMaterialObject(S,l):new THREE.Mesh(S,l),_.rotation.set(Math.PI/2,0,0);var O=f.rect[0]+E/2,G=e*E;if(_.position.x=O+G,d.numChunksD_2%2==0){var z=f.rect[1]+R/2-0,W=t*R*1;_.position.z=W+z}else{var z=f.rect[1]-R/2+0,W=t*R*1;_.position.z=z+W}var B=_.position.x,Y=_.position.z;a.mapRect||(a.mapRect={x1:B-E/2,x2:B+E/2,y1:Y-R/2,y2:Y+R/2}),a.mapRect.x1=Math.min(a.mapRect.x1,B-E/2),a.mapRect.x2=Math.max(a.mapRect.x2,B+E/2),a.mapRect.y1=Math.min(a.mapRect.y1,Y-R/2),a.mapRect.y2=Math.max(a.mapRect.y2,Y+R/2),_.updateMatrix(),_.updateMatrixWorld(),a.getOutput().terrainTiles.push(_)},D=function(t,r){if(t>=m&&(t=0,r++),r>=c)return a.getOutput().water=a.drawWater(a.mapRect),a.getOutput().bounds=a.mapRect,void e();var n=Math.floor(100*(r*m+t)/(m*c));a.logger.log(T3D.Logger.TYPE_PROGRESS,"Loading Terrain",n),F(t,r),setTimeout(D,1,t+1,r)};D(0,0)}}var n=e("../util/RenderUtils"),i=e("./DataRenderer"),o=e("../format/file/GW2File.js");r.prototype=Object.create(i.prototype),r.prototype.constructor=r,r.prototype.renderAsync=function(e){var t=this.mapFile.getChunk("trn").data.materials.pagedImage;this.localReader.loadFile(t,this.loadPagedImageCallback.bind(this,e))},r.prototype.getFileIdsAsync=function(e){var t=this.mapFile.getChunk("trn"),a=this.mapFile.getChunk("pimg"),r=[],n=a&&a.data,i=n.strippedPages;i.forEach(function(e){e.layer<=1&&e.filename>0&&r.push(e.filename)});var o=t.data,s=o.materials.texFileArray;return s.forEach(function(e){e.filename>0&&r.push(e.filename)}),r},t.exports=r},{"../format/file/GW2File.js":16,"../util/RenderUtils":20,"./DataRenderer":5}],12:[function(e,t,a){function r(e,t,a,r){i.call(this,e,t,a,r),this.mapFile=this.settings.mapFile,this.renderZone=function(e,t,a,r){function i(e){if(e>=d.length)return o.meshCache={},o.textureCache={},void r();var t=d[e],a=l[t],s=[],f=!1;n.getMeshesForFilename(t,null,o.localReader,o.meshCache,o.textureCache,f,function(t,r){t&&a.forEach(function(e,r){t.forEach(function(t,n){if(525!=t.materialFlags){var i={x:0,y:0,z:0};if(s[n])i.x=e.x-s[n].position.x,i.y=e.z-s[n].position.z,i.z=e.y-s[n].position.y;else{var o=t.geometry.clone(),l=o.attributes;s[n]={readVerts:l.position.array,verts:new Float32Array(a.length*l.position.array.length),readIndices:l.index.array,indices:new Uint32Array(a.length*l.index.array.length),readUVs:l.uv.array,uvs:new Float32Array(a.length*l.uv.array.length),readNormals:l.normal.array,normals:new Float32Array(a.length*l.normal.array.length),material:t.material,position:{x:e.x,y:e.y,z:e.z}}}for(var d=s[n].readVerts,f=s[n].verts,u=d.length,h=0,m=r*u;u>h;h+=3,m+=3)f[m+0]=d[h+0]+i.x,f[m+1]=d[h+1]+i.y,f[m+2]=d[h+2]+i.z;for(var c=s[n].readIndices,g=s[n].indices,p=c.length,v=u*r/3,h=0,m=r*p;p>h;h++,m++)g[m]=c[h]+v;for(var y=s[n].readUVs,E=s[n].uvs,R=y.length,h=0,m=r*R;R>h;h++,m++)E[m]=y[h];for(var T=s[n].readNormals,x=s[n].normals,M=T.length,h=0,m=r*M;M>h;h++,m++)x[m]=T[h]}})}),s.forEach(function(e){var t=new THREE.BufferGeometry;t.addAttribute("position",new THREE.BufferAttribute(e.verts,3)),t.addAttribute("index",new THREE.BufferAttribute(e.indices,1)),t.addAttribute("normal",new THREE.BufferAttribute(e.normals,3)),t.addAttribute("uv",new THREE.BufferAttribute(e.uvs,2)),t.buffersNeedUpdate=!0,mesh=new THREE.Mesh(t,e.material),mesh.position.set(e.position.x,e.position.z,e.position.y),o.getOutput().meshes.push(mesh)}),i(e+1)})}var o=this,s=null;t.forEach(function(t){s||t.token!=e.defToken||(s=t)});var l=this.getModelGroups(e,s,a);o.meshCache={},o.textureCache={};var d=Object.keys(l);i(0)},this.getModelGroups=function(e,t,a){var r=(e.zPos,a[0]),n=a[1],i=48,o={x1:e.vertRect[0]*i+r,x2:e.vertRect[2]*i+r,y1:e.vertRect[1]*-i-n,y2:e.vertRect[3]*-i-n};if(0==e.encodeData.length)return{};for(var s=e.vertRect[0]-e.vertRect[2],l=(e.vertRect[1]-e.vertRect[3],0),d={},f=this.getOutput(T3D.TerrainRenderer).terrainTiles,u=0;u<e.flags.length;u+=2){l+=e.flags[u];var h=e.flags[u+1];if(0!=h){var m=h>>4,c=t.layerDefArray[m-1];if(c){var g=l%s*i+o.x1,p=Math.floor(l/s)*i+o.y1,v=null,y=1e5,E=new THREE.Raycaster(new THREE.Vector3(g,y,p),new THREE.Vector3(0,-1,0));f.forEach(function(e){if(null===v){var t=E.intersectObject(e);t.length>0&&(v=y-t[0].distance)}});var R=0,T=c.modelArray[R],x=T.filename,M=(T.zOffsets,c.layerFlags,c.rotRangeX),N=c.rotRangeY,w=c.rotRangeZ,F=c.scaleRange,D=c.fadeRange;d[x]||(d[x]=[]),d[x].push({x:g,y:p,z:v,rotRangeX:M,rotRangeY:N,rotRangeZ:w,scaleRange:F,fadeRange:D})}}}return d}}var n=e("../util/RenderUtils"),i=e("./DataRenderer");r.prototype=Object.create(i.prototype),r.prototype.constructor=r,r.prototype.renderAsync=function(e){function t(r){var n=Math.round(100*r/o.length);return lastPct!=n&&(a.logger.log(T3D.Logger.TYPE_PROGRESS,"Loading 3D Models (Zone)",n),lastPct=n),r>=o.length?void e():void a.renderZone(o[r],s,i,t.bind(a,r+1))}var a=this;a.getOutput().meshes=[];var r=this.mapFile.getChunk("zon2").data,n=this.mapFile.getChunk("parm").data,i=(this.mapFile.getChunk("trn").data,n.rect),o=r.zoneArray,s=r.zoneDefArray;lastPct=-1,t(0)},t.exports=r},{"../util/RenderUtils":20,"./DataRenderer":5}],13:[function(e,t,a){t.exports=["version","uint8","magic","string:3","headerSize","uint32","unknown1","uint32","chunkSize","uint32","crc","uint32","unknown2","uint32","mftOffset",["[]","uint32",2],"mftSize","uint32","flags","uint32"]},{}],14:[function(e,t,a){t.exports=["magic","string:4","unknown1",["[]","uint32",2],"nbOfEntries","uint32","unknown2","uint32","unknown3","uint32"]},{}],15:[function(e,t,a){var r=["type","cstring:4","chunkDataSize","uint32","chunkVersion","uint16","chunkHeaderSize","uint16","offsetTableOffset","uint32"],n={ANIM:["MODL","Unknown"],GAME:["MODL","Unknown"],Main:["cntc","mMet"],SKEL:["MODL","Unknown"],TOOL:["AMAT","MODL"],main:["Unknown","Unknown","cmaC"],nvms:["Unknown","Unknown"]},i=function(e,t){this.ds=e,this.addr=t,this.data=null,this.headerLength=NaN,this.loadHead()};i.prototype.loadHead=function(){this.ds.seek(this.addr),this.header=this.ds.readStruct(r),this.headerLength=this.ds.position-this.addr},i.prototype.getDefinition=function(e){var t=0,a=n[this.header.type];if(a){t=-1;for(var r=0;r<a.length&&-1==t;r++){var i=a[r];i==e&&(t=r)}}for(var o=0,r=0;r<T3D.formats.length;r++){var s=T3D.formats[r];if(s.name==this.header.type){if(o==t&&s.versions[this.header.chunkVersion])return(new s.versions[this.header.chunkVersion]).__root;o++}}},i.prototype.loadData=function(e){var t=this.getDefinition(e);t?(this.ds.seek(this.addr+this.headerLength),this.data=this.ds.readStruct(t)):T3D.Logger.log(T3D.Logger.TYPE_WARNING,"Could not find a definition for chunk",this.header.type,"version",this.header.chunkVersion,"file name",e)},i.prototype.next=function(){try{return new i(this.ds,this.addr+8+this.header.chunkDataSize)}catch(e){}return null},t.exports=i},{}],16:[function(e,t,a){var r=e("./GW2Chunk"),n=["identifier","cstring:2","unknownField1","uint16","unknownField2","uint16","pkFileVersion","uint16","type","cstring:4"],i=function(e,t,a){this.ds=e,this.addr=t,this.data=null,this.headerLength=NaN,this.chunks=[],this.readHead(),a||this.readChunks()};i.prototype.readHead=function(){this.ds.seek(this.addr),this.header=this.ds.readStruct(n),this.headerLength=this.ds.position-this.addr},i.prototype.readChunks=function(){this.chunks=[];for(var e=new r(this.ds,this.headerLength+this.addr);null!=e&&e.header.type;)e.loadData(this.header.type),this.chunks.push(e),e=e.next()},i.prototype.getChunk=function(e){for(var t=0;t<this.chunks.length;t++)if(this.chunks[t].header.type.toLowerCase()==e.toLowerCase())return this.chunks[t];return null},i.prototype.getChunkStructs=function(){return{}},t.exports=i},{"./GW2Chunk":15}],17:[function(e,t,a){var r=t.exports={},n=(r.getMaterial=function(e,t,a,r){if(t){var i=t.getChunk("dx9s"),o=t.getChunk("grmt"),s=[];if(e&&e.textures.length){for(var l=i.data.techniques[0].passes[0].effects,d=l[0],f=(i.data.shaders[d.pixelShader],[]),u=0;u<d.samplerIndex.length;u++){var h=d.samplerIndex[u],m=i.data.samplers[h];if(m){var c=m&&o.data.texTokens[m.textureIndex];c||(c="0-0");var g=null;if(e.textures.forEach(function(e,t){g||e.token.split("-")[0]!=c.split("-")[0]||(g=e)}),g)f.push(g);else if(m)f.push(e.textures[m.textureIndex]);else{if(!(e.textures.length>0))return;f.push(e.textures[0])}}}if(f.length<=0)return;f.forEach(function(e,t){if(e){var i=e&&e.filename;s[t]=n(i,a,r),s[t]&&(s[t].uvIdx=e.uvPSInputIndex)}})}var p;if(s){var v=!1;if(e.textures.forEach(function(e){v||"1733499172"!=e.token.split("-")[0]||(v=e)}),!v||v.filename<=0)return;p=new THREE.MeshLambertMaterial({side:THREE.DoubleSide,map:n(v.filename,a,r)}),p.textureFilename=v.filename,16460!=o.data.flags&&(p.alphaTest=.05)}else p=new THREE.MeshBasicMaterial({side:THREE.DoubleSide,color:16711680,shading:THREE.FlatShading});if(p.needsUpdate=!0,e){var y=1,E=16,R=768,o=t.getChunk("grmt");e.materialFlags&y||e.materialFlags&E||e.materialFlags&R;var T=8,x=[16460,16452,16448,8268,3392,2380,2368,332,324,320,76,68,64];x.indexOf(o.data.flags)<0&&T3D.Logger.log(T3D.Logger.TYPE_WARNING,"unknown GR flag",o.data.flags),o.data.flags&T||(p=new THREE.MeshBasicMaterial({side:THREE.DoubleSide,map:p.map})),16460!=o.data.flags&&(p.alphaTest=.05)}return p}},r.getTexture=function(e,t,a){var r;return e&&a[e]?r=a[e]:e&&(r=i(t,e),r.wrapT=THREE.RepeatWrapping,r.wrapS=THREE.RepeatWrapping,r.flipY=!1,a[e]=r),r}),i=r.loadLocalTexture=function(e,t,a,r,n){void 0===r&&(r=Math.floor(16777215*Math.random()));var i=THREE.ImageUtils.generateDataTexture(1,1,new THREE.Color(r));return parseInt(t)<=0?(n&&n(),i):(e.loadTextureFile(t,function(e,t,a,r){if(!e)return void(n&&n());var o={data:new Uint8Array(e),width:a,height:r};i.format=THREE.RGBAFormat,i.image=o,i.needsUpdate=!0}),i)}},{}],18:[function(e,t,a){var r=t.exports={};r.f16=function(e){var t=(32768&e)>>15,a=(31744&e)>>10,r=1023&e;return 0==a?(t?-1:1)*Math.pow(2,-14)*(r/Math.pow(2,10)):31==a?r?NaN:(t?-1:1)*(1/0):(t?-1:1)*Math.pow(2,a-15)*(1+r/Math.pow(2,10))},r.popcount=function(e){var t=1431655765,a=858993459,r=252645135;return e-=e>>1&t,e=(e&a)+(e>>2&a),e=(e&r)+(e>>4&r),e+=e>>8,e+(e>>15)&63};var n=Math.pow(2,32);r.arr32To64=function(e){return n*e[1]+e[0]},r.sort_unique=function(e,t){for(var a=Array.prototype.sort.call(e,t),r={},n=[],i=0,o=a.length;o>i;++i)r.hasOwnProperty(a[i])||(n.push(a[i]),r[a[i]]=1);return n}},{}],19:[function(e,t,a){t.exports={getArrayReader:function(e,t){return function(a,r){var n=[];try{var i=a.readUint32(),o=a.readUint32();if(0==o)return n;var s=a.position-4+o,l=a.position;if(t&&i>t)throw"Array length "+i+" exceeded allowed maximum "+t;var l=a.position;a.seek(s),n=a.readType(["[]",e,i],r),a.seek(l)}catch(d){console.warn("getArrayReader Failed loading array",d),console.warn("getArrayReader Failed loading array, structDef",e)}return n}},getRefArrayReader:function(e){return function(t,a){var r=[],n=t.readUint32(),i=t.position+t.readUint32();if(0==n)return r;var o=t.position;t.seek(i);var s=t.readInt32Array(n),l=o-4;t.seek(l);var d=t.readUint32();l+=d;for(var f=0;f<s.length;f++)if(0!=s[f]){var u=l+4*f+s[f];t.seek(u);try{r.push(t.readStruct(e))}catch(h){r.push(null),console.warn("getRefArrayReader could not find refered data at offset",s[f],h)}}return t.seek(o),r}},getQWordReader:function(){return function(e,t){return e.readUint32()+"-"+e.readUint32()}},getStringReader:function(){return function(e,t){var a=e.position+e.readUint32(),r=e.position;e.seek(a);var n=e.readCString();return e.seek(r),n}},getString16Reader:function(e){return function(t,a){var r=t.position+t.readUint32()+(e?e:0),n=t.position;t.seek(r);for(var i,o="";t.position+2<t.byteLength&&0!=(i=t.readUint16());)o+=String.fromCharCode(i);return t.seek(n),o}},getPointerReader:function(e){return function(t,a){var r=t.readUint32();if(0==r)return{};var n=t.position-4+r,i=t.position;t.seek(n);var o=t.readStruct(e);return t.seek(i),o}},getFileNameReader:function(){return function(e,t){try{var a=e.position+e.readUint32(),r=e.position;e.seek(a);var n=e.readStruct(["m_lowPart","uint16","m_highPart","uint16","m_terminator","uint16"]),i=65280*(n.m_highPart-256)+(n.m_lowPart-256)+1;return 0>i&&(i=0),e.seek(r),i}catch(o){return e.seek(r),-1}}}}},{}],20:[function(e,t,a){var r=e("../format/file/GW2File"),n=e("./MaterialUtils"),i=e("./MathUtils"),o={},s={Position:1,Weights:2,Group:4,Normal:8,Color:16,Tangent:32,Bitangent:64,TangentFrame:128,UV32Mask:65280,UV16Mask:16711680,Unknown1:16777216,Unknown2:33554432,Unknown3:67108864,Unknown4:134217728,PositionCompressed:268435456,Unknown5:536870912},l=t.exports={},d=(l.renderRect=function(e,t,a,r){var n=e.x1-e.x2,i=e.y1-e.y2;r||(r=1);var o=(e.x1+e.x2)/2,s=(e.y1+e.y2)/2,l=t,d=new THREE.BoxGeometry(n,r,i);a=a||new THREE.MeshBasicMaterial({color:16711680,wireframe:!0});var f=new THREE.Mesh(d,a);return f.overdraw=!0,f.position.x=o,f.position.y=l,f.position.z=s,f},l.loadLocalTexture=function(e,t,a,r,i){return n.loadLocalTexture(e,t,a,r,i)},l.renderGeomChunk=function(e,t,a,r,l){var d=t.data.meshes,f=[],u=a.data.permutations[0].materials;return d.forEach(function(t){var d=t.geometry,h=d.verts.mesh.fvf,m=d.verts.vertexCount,c=d.verts.mesh.vertices,g=d.indices.indices,p=new THREE.BufferGeometry,v=new DataStream(c.buffer),y=c.length/m,E=new Float32Array(3*m),R=null,T=[],x=12*!!(h&s.Position)+4*!!(h&s.Weights)+4*!!(h&s.Group),M=x+12*!!(h&s.Normal)+4*!!(h&s.Color),N=M+12*!!(h&s.Tangent),w=N+12*!!(h&s.Bitangent),F=w+12*!!(h&s.TangentFrame),D=(h&s.UV32Mask)>>8,k=(h&s.UV16Mask)>>16,A=!!D,b=!!k||!!D,L=A?D:k,C=i.popcount(L);if(C=Math.min(C,1),b)for(var S=0;C>S;S++)T[S]=new Float32Array(2*m);h&s.Normal,h&s.Tangent,h&s.Bitangent,h&s.TangentFrame;for(var S=0;m>S;S++){v.seek(S*y);var P=v.readFloat32(),U=v.readFloat32(),H=v.readFloat32();if(E[3*S+0]=P,E[3*S+1]=-H,E[3*S+2]=-U,b)for(var I=0;C>I;I++){v.seek(S*y+F+I*(A?8:4));var _,O;A?(_=v.readUint32(),O=v.readUint32()):(_=i.f16(v.readUint16()),O=i.f16(v.readUint16())),T[I][2*S+0]=_,T[I][2*S+1]=O}}for(var G=new Uint16Array(g.length),S=0;S<g.length;S+=3)G[S+0]=g[S+0],G[S+1]=g[S+1],G[S+2]=g[S+2];if(p.addAttribute("position",new THREE.BufferAttribute(E,3)),p.addAttribute("index",new THREE.BufferAttribute(G,1)),R?(console.log("adding normals"),p.addAttribute("normal",new THREE.BufferAttribute(R,3)),p.normalizeNormals(),p.normalsNeedUpdate=!0):p.computeVertexNormals(),b){for(var I=0;C>I;I++){var z="uv"+(I>0?I+1:"");p.addAttribute(z,new THREE.BufferAttribute(T[I],2)),p.attributes[z].needsUpdate=!0}p.uvsNeedUpdate=!0}p.buffersNeedUpdate=!0;var W=t.materialIndex,B=u[W],Y=null;B&&o[B.filename]&&(Y=o[B.filename]);var j=n.getMaterial(B,Y,e,r);if(!j){if(!l)return;j=new THREE.MeshLambertMaterial({color:6009320,wireframe:!1,side:THREE.DoubleSide})}var V=new THREE.Mesh(p,j);B&&(V.materialFlags=B.materialFlags,V.materialFilename=B.filename),V.materialName=t.materialName,V.numLods=t.geometry.lods.length,V.lodOverride=a.data.lodOverride,V.flags=t.flags,V.numUV=C,f.push(V)}),f}),f=l.loadMeshFromModelFile=function(e,t,a,n,i,s){var l=[];a.loadFile(e,function(t){function f(e,t){if(e>=v.length)return void t();var n=v[e];return o[n.filename]?void f(e+1,t):void a.loadFile(n.filename,function(a){if(a){var i=new DataStream(a),s=new r(i,0);o[n.filename]=s}f(e+1,t)})}try{if(!t)throw"Could not find MFT entry for "+e;var u=new DataStream(t),h=new r(u,0),m=h.getChunk("modl"),c=h.getChunk("geom"),g=m.data.boundingSphere,p=g.center;g.radius+=Math.sqrt(p[0]*p[0]+Math.sqrt(p[1]*p[1]+p[2]*p[2]));var v=m.data.permutations[0].materials;f(0,function(){var e=d(a,c,m,n,i);e.forEach(function(e){var t=[0,8,9,520,2056,2057,2060,2061,2312,2316,2568,2569,2572,2573,2584,2824,2828,2840,4617,6664],a=2056;11!==t.indexOf(e.materialFlags),520==e.materialFlags,(i||e.materialFlags&a)&&(4==e.flags||1==e.flags||0==e.flags,l.push(e))}),s(l,g)})}catch(y){console.warn("Failed rendering model "+e,y);var E=new THREE.Mesh(new THREE.BoxGeometry(200,2e3,200),new THREE.MeshNormalMaterial);E.flags=4,E.materialFlags=2056,E.lodOverride=[1e6,1e6],l.push(E),s(l)}})};l.getMeshesForFilename=function(e,t,a,r,n,i,o){r[e]?o(r[e].meshes,!0,r[e].boundingSphere):f(e,t,a,n,i,function(t,a){t&&(r[e]={meshes:t,boundingSphere:a}),o(t,!1,a)})},l.getFilesUsedByModel=function(e,t,a){var n=[e];t.loadFile(e,function(t){try{if(!t)throw"Could not find MFT entry for "+e;var i=new DataStream(t),o=new r(i,0),s=o.getChunk("modl"),l=s.data.permutations[0].materials;l.forEach(function(e){var t=e.filename;n.push(t),e.textures.forEach(function(e){n.push(e.filename)})})}catch(d){console.warn("Could not export any data",d)}a(n)})}},{"../format/file/GW2File":16,"./MaterialUtils":17,"./MathUtils":18}]},{},[4])(4)});